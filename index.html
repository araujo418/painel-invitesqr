<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Confirmação de Presença</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .card-shadow {
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        .countdown-item {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
        }
        .header-nav {
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(10px);
        }
        .footer-bg {
            background: linear-gradient(135deg, #4a5568 0%, #2d3748 100%);
        }
        .stats-card {
            transition: transform 0.2s;
        }
        .stats-card:hover {
            transform: translateY(-2px);
        }
    </style>
</head>
<body class="min-h-screen gradient-bg">
    <!-- Loading Screen -->
    <div id="loadingScreen" class="fixed inset-0 bg-white flex items-center justify-center z-50">
        <div class="text-center">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-purple-600 mx-auto mb-4"></div>
            <p class="text-gray-600">Carregando...</p>
        </div>
    </div>

    <!-- Login Screen -->
    <div id="loginScreen" class="hidden min-h-screen flex items-center justify-center p-4">
        <div class="bg-white rounded-lg card-shadow p-8 w-full max-w-md">
            <h1 class="text-2xl font-bold text-center mb-6 text-gray-800">Sistema de Confirmação</h1>
            <form id="loginForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Nome de Usuário</label>
                    <input type="text" id="username" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Senha</label>
                    <input type="password" id="password" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
                </div>
                <button type="submit" class="w-full bg-purple-600 text-white py-2 rounded-md hover:bg-purple-700 transition duration-200">
                    Entrar
                </button>
            </form>
            <div class="mt-4 text-center">
                <button id="showRegister" class="text-purple-600 hover:underline">Criar conta gratuita</button>
            </div>
        </div>
    </div>

    <!-- Register Screen -->
    <div id="registerScreen" class="hidden min-h-screen flex items-center justify-center p-4">
        <div class="bg-white rounded-lg card-shadow p-8 w-full max-w-md">
            <h1 class="text-2xl font-bold text-center mb-6 text-gray-800">Criar Conta</h1>
            <form id="registerForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Nome Completo</label>
                    <input type="text" id="fullName" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Nome de Usuário</label>
                    <input type="text" id="regUsername" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                    <input type="email" id="email" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Senha</label>
                    <input type="password" id="regPassword" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
                </div>
                <button type="submit" class="w-full bg-purple-600 text-white py-2 rounded-md hover:bg-purple-700 transition duration-200">
                    Criar Conta
                </button>
            </form>
            <div class="mt-4 text-center">
                <button id="showLogin" class="text-purple-600 hover:underline">Já tenho conta</button>
            </div>
        </div>
    </div>

    <!-- Pending Approval Screen -->
    <div id="pendingScreen" class="hidden min-h-screen flex items-center justify-center p-4">
        <div class="bg-white rounded-lg card-shadow p-8 w-full max-w-md text-center">
            <div class="text-yellow-500 text-6xl mb-4">⏳</div>
            <h2 class="text-2xl font-bold mb-4 text-gray-800">Aguardando Aprovação</h2>
            <p class="text-gray-600 mb-6">Sua conta foi criada com sucesso! Aguarde a aprovação do administrador para começar a usar o sistema.</p>
            <button id="logoutBtn" class="bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600 transition duration-200">
                Sair
            </button>
        </div>
    </div>

    <!-- Admin Dashboard -->
    <div id="adminDashboard" class="hidden min-h-screen p-4">
        <div class="max-w-6xl mx-auto">
            <div class="bg-white rounded-lg card-shadow p-6 mb-6">
                <div class="flex justify-between items-center">
                    <h1 class="text-3xl font-bold text-gray-800">Painel Administrativo</h1>
                    <button id="adminLogout" class="bg-red-500 text-white px-4 py-2 rounded-md hover:bg-red-600 transition duration-200">
                        Sair
                    </button>
                </div>
            </div>

            <!-- Admin Navigation Tabs -->
            <div class="bg-white rounded-lg card-shadow mb-6">
                <div class="border-b border-gray-200">
                    <nav class="flex space-x-8 px-6">
                        <button onclick="showAdminTab('users')" class="admin-tab-btn py-4 px-1 border-b-2 border-purple-500 text-purple-600 font-medium" data-tab="users">
                            Usuários
                        </button>
                        <button onclick="showAdminTab('events')" class="admin-tab-btn py-4 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700" data-tab="events">
                            Eventos
                        </button>
                        <button onclick="showAdminTab('confirmations')" class="admin-tab-btn py-4 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700" data-tab="confirmations">
                            Confirmações
                        </button>
                        <button onclick="showAdminTab('site')" class="admin-tab-btn py-4 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700" data-tab="site">
                            Configurações do Site
                        </button>
                    </nav>
                </div>
            </div>

            <!-- Users Tab -->
            <div id="adminUsersTab" class="admin-tab-content">
                <div class="bg-white rounded-lg card-shadow p-6 mb-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold text-gray-800">Usuários Pendentes de Aprovação</h2>
                        <div class="text-sm text-gray-500">
                            <span id="pendingCount">0</span> pendentes
                        </div>
                    </div>
                    <div id="pendingUsers" class="space-y-4">
                        <!-- Pending users will be loaded here -->
                    </div>
                </div>

                <div class="bg-white rounded-lg card-shadow p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold text-gray-800">Todos os Usuários</h2>
                        <div class="text-sm text-gray-500">
                            <span id="totalUsersCount">0</span> usuários
                        </div>
                    </div>
                    <div id="allUsers" class="space-y-4">
                        <!-- All users will be loaded here -->
                    </div>
                </div>
            </div>

            <!-- Events Tab -->
            <div id="adminEventsTab" class="admin-tab-content hidden">
                <div class="bg-white rounded-lg card-shadow p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold text-gray-800">Todos os Eventos</h2>
                        <div class="text-sm text-gray-500">
                            <span id="totalEventsCount">0</span> eventos
                        </div>
                    </div>
                    <div id="allEvents" class="space-y-4">
                        <!-- All events will be loaded here -->
                    </div>
                </div>
            </div>

            <!-- Confirmations Tab -->
            <div id="adminConfirmationsTab" class="admin-tab-content hidden">
                <div class="bg-white rounded-lg card-shadow p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold text-gray-800">Todas as Confirmações</h2>
                        <div class="text-sm text-gray-500">
                            <span id="totalConfirmationsCount">0</span> confirmações
                        </div>
                    </div>
                    <div id="allConfirmations" class="space-y-4">
                        <!-- All confirmations will be loaded here -->
                    </div>
                </div>
            </div>

            <!-- Site Settings Tab -->
            <div id="adminSiteTab" class="admin-tab-content hidden">
                <div class="bg-white rounded-lg card-shadow p-6">
                    <h2 class="text-xl font-bold text-gray-800 mb-6">Configurações do Site</h2>
                    <form id="siteSettingsForm" class="space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Nome do Site</label>
                                <input type="text" id="siteName" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Telefone de Contacto</label>
                                <input type="text" id="contactPhone" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Texto "Quem Somos"</label>
                            <textarea id="aboutText" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500"></textarea>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Texto Estendido "Quem Somos"</label>
                            <textarea id="aboutExtended" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500"></textarea>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Lista de Serviços (um por linha)</label>
                            <textarea id="servicesList" rows="6" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500"></textarea>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Texto do Rodapé</label>
                            <input type="text" id="footerText" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Itens do Menu</label>
                            <div id="menuItemsContainer" class="space-y-2">
                                <!-- Menu items will be loaded here -->
                            </div>
                            <button type="button" onclick="addMenuItem()" class="mt-2 bg-green-500 text-white px-3 py-1 rounded hover:bg-green-600 transition duration-200">
                                Adicionar Item
                            </button>
                        </div>

                        <div class="flex justify-end">
                            <button type="submit" class="bg-purple-600 text-white px-6 py-2 rounded-md hover:bg-purple-700 transition duration-200">
                                Salvar Configurações
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- User Dashboard -->
    <div id="userDashboard" class="hidden min-h-screen p-4">
        <div class="max-w-7xl mx-auto">
            <div class="bg-white rounded-lg card-shadow p-6 mb-6">
                <div class="flex justify-between items-center">
                    <h1 class="text-3xl font-bold text-gray-800">Meus Eventos</h1>
                    <div class="space-x-2">
                        <button id="createEventBtn" class="bg-purple-600 text-white px-4 py-2 rounded-md hover:bg-purple-700 transition duration-200">
                            Criar Evento
                        </button>
                        <button id="userLogout" class="bg-red-500 text-white px-4 py-2 rounded-md hover:bg-red-600 transition duration-200">
                            Sair
                        </button>
                    </div>
                </div>
            </div>
            
            <div id="eventsContainer" class="space-y-8">
                <!-- Events will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Create Event Modal -->
    <div id="createEventModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg p-6 w-full max-w-2xl max-h-[90vh] overflow-y-auto">
            <h2 class="text-2xl font-bold mb-4 text-gray-800">Criar Novo Evento</h2>
            <form id="createEventForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Nome do Evento *</label>
                    <input type="text" id="eventName" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Data do Evento *</label>
                    <input type="date" id="eventDate" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Data Limite para Confirmação</label>
                    <input type="date" id="confirmationDeadline" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Local</label>
                    <input type="text" id="eventLocation" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Horário</label>
                    <input type="time" id="eventTime" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Descrição</label>
                    <textarea id="eventDescription" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500"></textarea>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Lista de Presentes (um por linha)</label>
                    <textarea id="giftList" rows="5" placeholder="iPhone 15&#10;Notebook Dell&#10;Cafeteira Nespresso" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500"></textarea>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">IBAN para Presentes em Dinheiro</label>
                    <input type="text" id="iban" placeholder="PT50 0000 0000 0000 0000 0000 0" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Mensagem para IBAN</label>
                    <textarea id="ibanMessage" rows="2" placeholder="Sua contribuição é muito importante para nós!" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500"></textarea>
                </div>
                <div class="flex items-center">
                    <input type="checkbox" id="allowDuplicateGifts" class="mr-2">
                    <label for="allowDuplicateGifts" class="text-sm text-gray-700">Permitir que múltiplas pessoas escolham o mesmo presente</label>
                </div>
                <div class="flex justify-end space-x-2 pt-4">
                    <button type="button" id="cancelCreateEvent" class="px-4 py-2 text-gray-600 border border-gray-300 rounded-md hover:bg-gray-50 transition duration-200">
                        Cancelar
                    </button>
                    <button type="submit" class="px-4 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700 transition duration-200">
                        Criar Evento
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Guest Header Navigation -->
    <div id="guestHeader" class="hidden fixed top-0 left-0 right-0 z-40 header-nav border-b">
        <div class="max-w-6xl mx-auto px-4 py-3">
            <div class="flex justify-between items-center">
                <div class="flex items-center space-x-6">
                    <h1 class="text-xl font-bold text-purple-600 brand-name">Invites</h1>
                    <nav class="hidden md:flex space-x-4">
                        <button onclick="showAboutModal()" class="text-gray-600 hover:text-purple-600 transition duration-200">Quem Somos</button>
                        <button onclick="showServicesModal()" class="text-gray-600 hover:text-purple-600 transition duration-200">Serviços</button>
                        <button onclick="showContactModal()" class="text-gray-600 hover:text-purple-600 transition duration-200">Contactos</button>
                    </nav>
                </div>
                <button onclick="showGuestLogin()" class="bg-purple-600 text-white px-4 py-2 rounded-md hover:bg-purple-700 transition duration-200">
                    Login
                </button>
            </div>
        </div>
    </div>

    <!-- Guest Confirmation Page -->
    <div id="guestPage" class="hidden min-h-screen">
        <div class="pt-20 p-4">
            <div class="max-w-4xl mx-auto">
                <div class="bg-white rounded-lg card-shadow p-8 text-center">
                    <div id="eventHeader" class="mb-8">
                        <!-- Event details will be loaded here -->
                    </div>
                
                <div id="countdownContainer" class="mb-8">
                    <!-- Countdown will be displayed here -->
                </div>
                
                <div id="confirmationForm" class="max-w-md mx-auto">
                    <!-- Confirmation form will be loaded here -->
                </div>
                
                <div id="messageBoard" class="hidden mt-8">
                    <!-- Message board will be displayed here -->
                </div>
                
                <div id="giftSelection" class="hidden mt-8">
                    <!-- Gift selection will be displayed here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <div id="footer" class="footer-bg text-white py-6 mt-8">
        <div class="max-w-6xl mx-auto px-4 text-center">
            <p class="text-sm">Copyright © Invites</p>
        </div>
    </div>

    <!-- Modal for About -->
    <div id="aboutModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg p-6 w-full max-w-md">
            <h2 class="text-2xl font-bold mb-4 text-gray-800">Quem Somos</h2>
            <p id="aboutModalText" class="text-gray-600 mb-4">
                A Invites é uma plataforma especializada em sistemas de confirmação de presença para eventos. 
                Oferecemos soluções completas e personalizadas para tornar a organização do seu evento mais fácil e eficiente.
            </p>
            <p id="aboutModalExtended" class="text-gray-600 mb-6">
                Com nossa tecnologia avançada, você pode criar páginas únicas para seus convidados, 
                gerenciar confirmações de presença, receber mensagens e organizar listas de presentes de forma simples e intuitiva.
            </p>
            <button onclick="closeModal('aboutModal')" class="w-full bg-purple-600 text-white py-2 rounded-md hover:bg-purple-700 transition duration-200">
                Fechar
            </button>
        </div>
    </div>

    <!-- Modal for Services -->
    <div id="servicesModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg p-6 w-full max-w-md">
            <h2 class="text-2xl font-bold mb-4 text-gray-800">Nossos Serviços</h2>
            <div id="servicesModalList" class="space-y-3 text-gray-600 mb-6">
                <div class="flex items-start">
                    <span class="text-purple-600 mr-2">✓</span>
                    <span>Criação de páginas personalizadas para eventos</span>
                </div>
                <div class="flex items-start">
                    <span class="text-purple-600 mr-2">✓</span>
                    <span>Sistema de confirmação de presença com acompanhantes</span>
                </div>
                <div class="flex items-start">
                    <span class="text-purple-600 mr-2">✓</span>
                    <span>Mural de mensagens para convidados</span>
                </div>
                <div class="flex items-start">
                    <span class="text-purple-600 mr-2">✓</span>
                    <span>Gestão de listas de presentes</span>
                </div>
                <div class="flex items-start">
                    <span class="text-purple-600 mr-2">✓</span>
                    <span>Contagem regressiva para confirmações</span>
                </div>
                <div class="flex items-start">
                    <span class="text-purple-600 mr-2">✓</span>
                    <span>Relatórios detalhados de confirmações</span>
                </div>
            </div>
            <button onclick="closeModal('servicesModal')" class="w-full bg-purple-600 text-white py-2 rounded-md hover:bg-purple-700 transition duration-200">
                Fechar
            </button>
        </div>
    </div>

    <!-- Modal for Contact -->
    <div id="contactModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg p-6 w-full max-w-md">
            <h2 class="text-2xl font-bold mb-4 text-gray-800">Contactos</h2>
            <div class="space-y-4 text-gray-600 mb-6">
                <div class="flex items-center">
                    <span class="text-purple-600 mr-3">📞</span>
                    <span id="contactPhoneModal" class="font-semibold">959 823 409</span>
                </div>
                <div class="flex items-center">
                    <span class="text-purple-600 mr-3">✉️</span>
                    <span>Entre em contacto connosco para mais informações sobre nossos serviços</span>
                </div>
                <div class="flex items-center">
                    <span class="text-purple-600 mr-3">🌐</span>
                    <span>Disponível 24/7 através da nossa plataforma online</span>
                </div>
            </div>
            <button onclick="closeModal('contactModal')" class="w-full bg-purple-600 text-white py-2 rounded-md hover:bg-purple-700 transition duration-200">
                Fechar
            </button>
        </div>
    </div>

    <!-- Notification Container -->
    <div id="notificationContainer" class="fixed top-4 right-4 z-50 space-y-2"></div>

    <script>
        // Supabase configuration
        const supabaseUrl = 'https://drmdjuewsarzhiwytnsy.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRybWRqdWV3c2Fyemhpd3l0bnN5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU5MjE5OTgsImV4cCI6MjA3MTQ5Nzk5OH0.l1XKUSsp74sW5q_GMcVOSinHBum8c8X7TyPtsuMOMww';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

        // Global variables
        let currentUser = null;
        let currentEvent = null;
        let isAdmin = false;
        let siteSettings = {};

        // Admin credentials
        const ADMIN_USERNAME = 'Invites';
        const ADMIN_PASSWORD = '#Invites2025@!!1995';

        // Notification system
        function showNotification(message, type = 'info') {
            const container = document.getElementById('notificationContainer');
            const notification = document.createElement('div');
            
            const colors = {
                success: 'bg-green-500',
                error: 'bg-red-500',
                warning: 'bg-yellow-500',
                info: 'bg-blue-500'
            };
            
            notification.className = `${colors[type]} text-white px-4 py-2 rounded-lg shadow-lg transform transition-all duration-300 translate-x-full opacity-0`;
            notification.textContent = message;
            
            container.appendChild(notification);
            
            // Animate in
            setTimeout(() => {
                notification.classList.remove('translate-x-full', 'opacity-0');
            }, 100);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                notification.classList.add('translate-x-full', 'opacity-0');
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 5000);
        }

        // Initialize app
        document.addEventListener('DOMContentLoaded', async function() {
            await initializeDatabase();
            await loadSiteSettings();
            checkCurrentUser();
            setupEventListeners();
        });

        // Database initialization
        async function initializeDatabase() {
            try {
                // Initialize site settings if not exists
                const { data: settings, error } = await supabase
                    .from('site_settings')
                    .select('*')
                    .limit(1);

                if (!settings || settings.length === 0) {
                    const defaultServices = [
                        'Criação de páginas personalizadas para eventos',
                        'Sistema de confirmação de presença com acompanhantes',
                        'Mural de mensagens para convidados',
                        'Gestão de listas de presentes',
                        'Contagem regressiva para confirmações',
                        'Relatórios detalhados de confirmações'
                    ];
                    
                    const defaultMenuItems = [
                        { name: 'Quem Somos', action: 'showAboutModal' },
                        { name: 'Serviços', action: 'showServicesModal' },
                        { name: 'Contactos', action: 'showContactModal' }
                    ];

                    await supabase.from('site_settings').insert([{
                        site_name: 'Invites',
                        contact_phone: '959 823 409',
                        about_text: 'A Invites é uma plataforma especializada em sistemas de confirmação de presença para eventos. Oferecemos soluções completas e personalizadas para tornar a organização do seu evento mais fácil e eficiente.',
                        about_extended: 'Com nossa tecnologia avançada, você pode criar páginas únicas para seus convidados, gerenciar confirmações de presença, receber mensagens e organizar listas de presentes de forma simples e intuitiva.',
                        services_list: JSON.stringify(defaultServices),
                        menu_items: JSON.stringify(defaultMenuItems),
                        footer_text: 'Copyright © Invites',
                        created_at: new Date().toISOString()
                    }]);
                }

                console.log('Database initialization complete');
            } catch (error) {
                console.error('Database initialization error:', error);
            }
        }

        // Load site settings from Supabase
        async function loadSiteSettings() {
            try {
                const { data, error } = await supabase
                    .from('site_settings')
                    .select('*')
                    .limit(1);

                if (data && data.length > 0) {
                    siteSettings = data[0];
                    updateSiteContent();
                }
            } catch (error) {
                console.error('Error loading site settings:', error);
            }
        }

        // Update site content based on settings
        function updateSiteContent() {
            try {
                // Update header brand
                const brandElements = document.querySelectorAll('.brand-name');
                brandElements.forEach(el => el.textContent = siteSettings.site_name || 'Invites');

                // Update footer
                const footerElement = document.querySelector('#footer p');
                if (footerElement) {
                    footerElement.textContent = siteSettings.footer_text || 'Copyright © Invites';
                }

                // Update modals content
                if (siteSettings.about_text) {
                    const aboutTextEl = document.getElementById('aboutModalText');
                    if (aboutTextEl) aboutTextEl.textContent = siteSettings.about_text;
                }
                if (siteSettings.about_extended) {
                    const aboutExtEl = document.getElementById('aboutModalExtended');
                    if (aboutExtEl) aboutExtEl.textContent = siteSettings.about_extended;
                }
                if (siteSettings.contact_phone) {
                    const contactPhoneEl = document.getElementById('contactPhoneModal');
                    if (contactPhoneEl) contactPhoneEl.textContent = siteSettings.contact_phone;
                }

                // Update services list
                if (siteSettings.services_list) {
                    try {
                        const servicesList = typeof siteSettings.services_list === 'string' 
                            ? JSON.parse(siteSettings.services_list) 
                            : siteSettings.services_list;
                        
                        const servicesContainer = document.getElementById('servicesModalList');
                        if (servicesContainer && Array.isArray(servicesList)) {
                            servicesContainer.innerHTML = servicesList.map(service => `
                                <div class="flex items-start">
                                    <span class="text-purple-600 mr-2">✓</span>
                                    <span>${service}</span>
                                </div>
                            `).join('');
                        }
                    } catch (e) {
                        console.error('Error parsing services list:', e);
                    }
                }

                // Update navigation menu
                updateNavigationMenu();
            } catch (error) {
                console.error('Error updating site content:', error);
            }
        }

        // Update navigation menu
        function updateNavigationMenu() {
            try {
                const navElement = document.querySelector('#guestHeader nav');
                if (navElement && siteSettings.menu_items) {
                    const menuItems = typeof siteSettings.menu_items === 'string' 
                        ? JSON.parse(siteSettings.menu_items) 
                        : siteSettings.menu_items;
                    
                    if (Array.isArray(menuItems)) {
                        navElement.innerHTML = menuItems.map(item => 
                            `<button onclick="${item.action}()" class="text-gray-600 hover:text-purple-600 transition duration-200">${item.name}</button>`
                        ).join('');
                    }
                }
            } catch (error) {
                console.error('Error updating navigation menu:', error);
            }
        }

        // Check current user session
        async function checkCurrentUser() {
            const userData = sessionStorage.getItem('currentUser');
            if (userData) {
                currentUser = JSON.parse(userData);
                if (currentUser.username === ADMIN_USERNAME) {
                    isAdmin = true;
                    showAdminDashboard();
                } else if (currentUser.is_approved) {
                    showUserDashboard();
                } else {
                    showPendingScreen();
                }
            } else {
                // Check if we're on a guest confirmation page
                const urlParams = new URLSearchParams(window.location.search);
                let eventId = urlParams.get('event');
                let withCompanions = urlParams.get('companions') === 'true';
                
                // Also check for Canvas-style URLs in the path
                const path = window.location.pathname;
                const canvasUrlMatch = path.match(/\/confirmar\/(\d+)\//);
                if (canvasUrlMatch) {
                    eventId = canvasUrlMatch[1];
                    withCompanions = path.includes('com-acompanhantes');
                }
                
                if (eventId) {
                    await loadGuestPage(eventId, withCompanions);
                } else {
                    showLoginScreen();
                }
            }
            hideLoadingScreen();
        }

        // Setup event listeners
        function setupEventListeners() {
            // Login form
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            document.getElementById('showRegister').addEventListener('click', showRegisterScreen);
            
            // Register form
            document.getElementById('registerForm').addEventListener('submit', handleRegister);
            document.getElementById('showLogin').addEventListener('click', showLoginScreen);
            
            // Logout buttons
            document.getElementById('logoutBtn').addEventListener('click', logout);
            document.getElementById('adminLogout').addEventListener('click', logout);
            document.getElementById('userLogout').addEventListener('click', logout);
            
            // Create event
            document.getElementById('createEventBtn').addEventListener('click', showCreateEventModal);
            document.getElementById('createEventForm').addEventListener('submit', handleCreateEvent);
            document.getElementById('cancelCreateEvent').addEventListener('click', hideCreateEventModal);
        }

        // Screen management functions
        function hideLoadingScreen() {
            document.getElementById('loadingScreen').classList.add('hidden');
        }

        function showLoginScreen() {
            hideAllScreens();
            document.getElementById('loginScreen').classList.remove('hidden');
        }

        function showRegisterScreen() {
            hideAllScreens();
            document.getElementById('registerScreen').classList.remove('hidden');
        }

        function showPendingScreen() {
            hideAllScreens();
            document.getElementById('pendingScreen').classList.remove('hidden');
        }

        function showAdminDashboard() {
            hideAllScreens();
            document.getElementById('adminDashboard').classList.remove('hidden');
            showAdminTab('users'); // Load first tab by default
        }

        function showUserDashboard() {
            hideAllScreens();
            document.getElementById('userDashboard').classList.remove('hidden');
            loadUserEvents();
        }

        function hideAllScreens() {
            const screens = ['loginScreen', 'registerScreen', 'pendingScreen', 'adminDashboard', 'userDashboard', 'guestPage', 'guestHeader'];
            screens.forEach(screen => {
                document.getElementById(screen).classList.add('hidden');
            });
        }

        // Authentication functions
        async function handleLogin(e) {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            // Check admin credentials
            if (username === ADMIN_USERNAME && password === ADMIN_PASSWORD) {
                currentUser = { username: ADMIN_USERNAME, isAdmin: true };
                sessionStorage.setItem('currentUser', JSON.stringify(currentUser));
                isAdmin = true;
                showAdminDashboard();
                return;
            }

            try {
                // Check user credentials in Supabase
                const { data: users, error } = await supabase
                    .from('users')
                    .select('*')
                    .eq('username', username)
                    .eq('password_hash', password)
                    .limit(1);

                if (error) throw error;

                if (users && users.length > 0) {
                    const user = users[0];
                    currentUser = user;
                    sessionStorage.setItem('currentUser', JSON.stringify(currentUser));
                    
                    if (user.is_approved) {
                        showUserDashboard();
                    } else {
                        showPendingScreen();
                    }
                } else {
                    showNotification('Credenciais inválidas!', 'error');
                }
            } catch (error) {
                console.error('Login error:', error);
                showNotification('Erro ao fazer login. Tente novamente.', 'error');
            }
        }

        async function handleRegister(e) {
            e.preventDefault();
            const fullName = document.getElementById('fullName').value;
            const username = document.getElementById('regUsername').value;
            const email = document.getElementById('email').value;
            const password = document.getElementById('regPassword').value;

            try {
                // Check if username or email already exists
                const { data: existingUsers, error: checkError } = await supabase
                    .from('users')
                    .select('username, email')
                    .or(`username.eq.${username},email.eq.${email}`);

                if (checkError) throw checkError;

                if (existingUsers && existingUsers.length > 0) {
                    showNotification('Nome de usuário ou email já existe!', 'error');
                    return;
                }

                // Create new user
                const { data, error } = await supabase
                    .from('users')
                    .insert([{
                        full_name: fullName,
                        username: username,
                        email: email,
                        password_hash: password,
                        is_approved: false
                    }])
                    .select();

                if (error) throw error;

                showNotification('Conta criada com sucesso! Aguarde a aprovação do administrador.', 'success');
                showLoginScreen();
            } catch (error) {
                console.error('Registration error:', error);
                showNotification('Erro ao criar conta. Tente novamente.', 'error');
            }
        }

        function logout() {
            sessionStorage.removeItem('currentUser');
            currentUser = null;
            isAdmin = false;
            showLoginScreen();
        }

        // Admin functions
        async function showAdminTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.admin-tab-btn').forEach(btn => {
                btn.classList.remove('border-purple-500', 'text-purple-600', 'font-medium');
                btn.classList.add('border-transparent', 'text-gray-500');
            });
            
            document.querySelector(`[data-tab="${tabName}"]`).classList.remove('border-transparent', 'text-gray-500');
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('border-purple-500', 'text-purple-600', 'font-medium');

            // Show/hide tab content
            document.querySelectorAll('.admin-tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            
            document.getElementById(`admin${tabName.charAt(0).toUpperCase() + tabName.slice(1)}Tab`).classList.remove('hidden');

            // Load content based on tab
            switch(tabName) {
                case 'users':
                    await loadPendingUsers();
                    await loadAllUsers();
                    break;
                case 'events':
                    await loadAllEvents();
                    break;
                case 'confirmations':
                    await loadAllConfirmations();
                    break;
                case 'site':
                    await loadSiteSettingsForm();
                    break;
            }
        }

        async function loadPendingUsers() {
            try {
                const { data: users, error } = await supabase
                    .from('users')
                    .select('*')
                    .eq('is_approved', false)
                    .order('created_at', { ascending: false });

                if (error) throw error;

                const container = document.getElementById('pendingUsers');
                const countElement = document.getElementById('pendingCount');
                
                countElement.textContent = users.length;

                if (users.length === 0) {
                    container.innerHTML = '<p class="text-gray-500 text-center">Nenhum usuário pendente de aprovação.</p>';
                    return;
                }

                container.innerHTML = users.map(user => `
                    <div class="border rounded-lg p-4 flex justify-between items-center">
                        <div>
                            <h3 class="font-semibold">${user.full_name}</h3>
                            <p class="text-gray-600">@${user.username} • ${user.email}</p>
                            <p class="text-sm text-gray-500">Criado em: ${new Date(user.created_at).toLocaleDateString('pt-BR')}</p>
                        </div>
                        <div class="space-x-2">
                            <button onclick="approveUser(${user.id})" class="bg-green-500 text-white px-3 py-1 rounded hover:bg-green-600 transition duration-200">
                                Aprovar
                            </button>
                            <button onclick="rejectUser(${user.id})" class="bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600 transition duration-200">
                                Recusar
                            </button>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading pending users:', error);
            }
        }

        async function loadAllUsers() {
            try {
                const { data: users, error } = await supabase
                    .from('users')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) throw error;

                const container = document.getElementById('allUsers');
                const countElement = document.getElementById('totalUsersCount');
                
                countElement.textContent = users.length;

                container.innerHTML = users.map(user => `
                    <div class="border rounded-lg p-4 flex justify-between items-center">
                        <div>
                            <h3 class="font-semibold">${user.full_name}</h3>
                            <p class="text-gray-600">@${user.username} • ${user.email}</p>
                            <p class="text-sm text-gray-500">
                                Status: <span class="px-2 py-1 rounded text-xs ${user.is_approved ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}">${user.is_approved ? 'Aprovado' : 'Pendente'}</span>
                                • Criado em: ${new Date(user.created_at).toLocaleDateString('pt-BR')}
                            </p>
                            <p class="text-xs text-gray-400 mt-1">
                                Senha: <span id="password-${user.id}" class="font-mono">••••••••</span>
                                <button onclick="togglePassword(${user.id}, '${user.password_hash}')" class="ml-2 text-blue-500 hover:underline">Ver</button>
                            </p>
                        </div>
                        <div class="space-x-2">
                            ${!user.is_approved ? `
                                <button onclick="approveUser(${user.id})" class="bg-green-500 text-white px-3 py-1 rounded hover:bg-green-600 transition duration-200">
                                    Aprovar
                                </button>
                            ` : ''}
                            <button onclick="deleteUser(${user.id})" class="bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600 transition duration-200">
                                Excluir
                            </button>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading all users:', error);
            }
        }

        async function loadAllEvents() {
            try {
                const { data: events, error } = await supabase
                    .from('events')
                    .select(`
                        *,
                        users (full_name, username)
                    `)
                    .order('created_at', { ascending: false });

                if (error) throw error;

                const container = document.getElementById('allEvents');
                const countElement = document.getElementById('totalEventsCount');
                
                countElement.textContent = events.length;

                if (events.length === 0) {
                    container.innerHTML = '<p class="text-gray-500 text-center">Nenhum evento criado ainda.</p>';
                    return;
                }

                container.innerHTML = events.map(event => `
                    <div class="border rounded-lg p-4">
                        <div class="flex justify-between items-start mb-2">
                            <div>
                                <h3 class="font-semibold text-lg">${event.name}</h3>
                                <p class="text-gray-600">Por: ${event.users?.full_name || 'Usuário removido'} (@${event.users?.username || 'N/A'})</p>
                                <p class="text-gray-500">Data: ${new Date(event.date).toLocaleDateString('pt-BR')}</p>
                                ${event.location ? `<p class="text-gray-500">Local: ${event.location}</p>` : ''}
                            </div>
                            <div class="space-x-2">
                                <button onclick="deleteEvent(${event.id})" class="bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600 transition duration-200">
                                    Excluir
                                </button>
                            </div>
                        </div>
                        ${event.description ? `<p class="text-gray-700 text-sm mt-2">${event.description}</p>` : ''}
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading all events:', error);
            }
        }

        async function loadAllConfirmations() {
            try {
                const { data: confirmations, error } = await supabase
                    .from('confirmations')
                    .select(`
                        *,
                        events (name, date, users (full_name))
                    `)
                    .order('created_at', { ascending: false });

                if (error) throw error;

                const container = document.getElementById('allConfirmations');
                const countElement = document.getElementById('totalConfirmationsCount');
                
                countElement.textContent = confirmations.length;

                if (confirmations.length === 0) {
                    container.innerHTML = '<p class="text-gray-500 text-center">Nenhuma confirmação ainda.</p>';
                    return;
                }

                container.innerHTML = confirmations.map(conf => `
                    <div class="border rounded-lg p-4">
                        <div class="flex justify-between items-start">
                            <div>
                                <h3 class="font-semibold">${conf.guest_name}</h3>
                                <p class="text-gray-600">${conf.guest_email || 'Email não informado'}</p>
                                <p class="text-gray-500">Evento: ${conf.events?.name || 'Evento removido'}</p>
                                <p class="text-gray-500">Organizador: ${conf.events?.users?.full_name || 'N/A'}</p>
                                <p class="text-sm text-gray-500">
                                    Status: <span class="px-2 py-1 rounded text-xs ${conf.will_attend ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">${conf.will_attend ? 'Confirmado' : 'Não comparecerá'}</span>
                                    ${conf.companions > 0 ? `• ${conf.companions} acompanhante(s)` : ''}
                                </p>
                            </div>
                            <button onclick="deleteConfirmation(${conf.id})" class="bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600 transition duration-200">
                                Excluir
                            </button>
                        </div>
                        ${conf.message ? `<p class="text-gray-700 text-sm mt-2 bg-gray-50 p-2 rounded">"${conf.message}"</p>` : ''}
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading all confirmations:', error);
            }
        }

        async function loadSiteSettingsForm() {
            try {
                const form = document.getElementById('siteSettingsForm');
                
                // Populate form with current settings
                document.getElementById('siteName').value = siteSettings.site_name || '';
                document.getElementById('contactPhone').value = siteSettings.contact_phone || '';
                document.getElementById('aboutText').value = siteSettings.about_text || '';
                document.getElementById('aboutExtended').value = siteSettings.about_extended || '';
                document.getElementById('footerText').value = siteSettings.footer_text || '';
                
                // Services list
                const servicesList = siteSettings.services_list ? JSON.parse(siteSettings.services_list) : [];
                document.getElementById('servicesList').value = servicesList.join('\n');
                
                // Menu items
                loadMenuItems();
                
                // Setup form submission
                form.onsubmit = async function(e) {
                    e.preventDefault();
                    await saveSiteSettings();
                };
            } catch (error) {
                console.error('Error loading site settings form:', error);
            }
        }

        function loadMenuItems() {
            const container = document.getElementById('menuItemsContainer');
            const menuItems = siteSettings.menu_items ? JSON.parse(siteSettings.menu_items) : [];
            
            container.innerHTML = menuItems.map((item, index) => `
                <div class="flex space-x-2 items-center">
                    <input type="text" value="${item.name}" onchange="updateMenuItem(${index}, 'name', this.value)" class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500" placeholder="Nome do menu">
                    <input type="text" value="${item.action}" onchange="updateMenuItem(${index}, 'action', this.value)" class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500" placeholder="Função (ex: showAboutModal)">
                    <button type="button" onclick="removeMenuItem(${index})" class="bg-red-500 text-white px-2 py-2 rounded hover:bg-red-600 transition duration-200">
                        ✕
                    </button>
                </div>
            `).join('');
        }

        function addMenuItem() {
            const menuItems = siteSettings.menu_items ? JSON.parse(siteSettings.menu_items) : [];
            menuItems.push({ name: '', action: '' });
            siteSettings.menu_items = JSON.stringify(menuItems);
            loadMenuItems();
        }

        function removeMenuItem(index) {
            const menuItems = JSON.parse(siteSettings.menu_items);
            menuItems.splice(index, 1);
            siteSettings.menu_items = JSON.stringify(menuItems);
            loadMenuItems();
        }

        function updateMenuItem(index, field, value) {
            const menuItems = JSON.parse(siteSettings.menu_items);
            menuItems[index][field] = value;
            siteSettings.menu_items = JSON.stringify(menuItems);
        }

        async function saveSiteSettings() {
            try {
                const servicesList = document.getElementById('servicesList').value
                    .split('\n')
                    .filter(s => s.trim())
                    .map(s => s.trim());

                const updatedSettings = {
                    site_name: document.getElementById('siteName').value,
                    contact_phone: document.getElementById('contactPhone').value,
                    about_text: document.getElementById('aboutText').value,
                    about_extended: document.getElementById('aboutExtended').value,
                    services_list: JSON.stringify(servicesList),
                    footer_text: document.getElementById('footerText').value,
                    menu_items: siteSettings.menu_items,
                    updated_at: new Date().toISOString()
                };

                const { error } = await supabase
                    .from('site_settings')
                    .update(updatedSettings)
                    .eq('id', siteSettings.id);

                if (error) throw error;

                // Update local settings and UI
                Object.assign(siteSettings, updatedSettings);
                updateSiteContent();
                
                showNotification('Configurações salvas com sucesso!', 'success');
            } catch (error) {
                console.error('Error saving site settings:', error);
                showNotification('Erro ao salvar configurações. Tente novamente.', 'error');
            }
        }

        async function approveUser(userId) {
            try {
                const { error } = await supabase
                    .from('users')
                    .update({ is_approved: true })
                    .eq('id', userId);

                if (error) throw error;

                await loadPendingUsers();
                await loadAllUsers();
                showNotification('Usuário aprovado com sucesso!', 'success');
            } catch (error) {
                console.error('Error approving user:', error);
                showNotification('Erro ao aprovar usuário.', 'error');
            }
        }

        async function rejectUser(userId) {
            await deleteUser(userId);
        }

        async function deleteUser(userId) {
            if (!confirm('Tem certeza que deseja excluir este usuário? Esta ação não pode ser desfeita.')) {
                return;
            }

            try {
                const { error } = await supabase
                    .from('users')
                    .delete()
                    .eq('id', userId);

                if (error) throw error;

                await loadPendingUsers();
                await loadAllUsers();
                showNotification('Usuário excluído com sucesso!', 'success');
            } catch (error) {
                console.error('Error deleting user:', error);
                showNotification('Erro ao excluir usuário.', 'error');
            }
        }

        async function deleteEvent(eventId) {
            if (!confirm('Tem certeza que deseja excluir este evento? Todas as confirmações relacionadas também serão excluídas.')) {
                return;
            }

            try {
                const { error } = await supabase
                    .from('events')
                    .delete()
                    .eq('id', eventId);

                if (error) throw error;

                await loadAllEvents();
                showNotification('Evento excluído com sucesso!', 'success');
            } catch (error) {
                console.error('Error deleting event:', error);
                showNotification('Erro ao excluir evento.', 'error');
            }
        }

        async function deleteConfirmation(confirmationId) {
            if (!confirm('Tem certeza que deseja excluir esta confirmação?')) {
                return;
            }

            try {
                const { error } = await supabase
                    .from('confirmations')
                    .delete()
                    .eq('id', confirmationId);

                if (error) throw error;

                await loadAllConfirmations();
                showNotification('Confirmação excluída com sucesso!', 'success');
            } catch (error) {
                console.error('Error deleting confirmation:', error);
                showNotification('Erro ao excluir confirmação.', 'error');
            }
        }

        function togglePassword(userId, password) {
            const passwordElement = document.getElementById(`password-${userId}`);
            const button = passwordElement.nextElementSibling;
            
            if (passwordElement.textContent === '••••••••') {
                passwordElement.textContent = password;
                button.textContent = 'Ocultar';
            } else {
                passwordElement.textContent = '••••••••';
                button.textContent = 'Ver';
            }
        }

        // User dashboard functions - UPDATED TO SHOW ALL INFO DIRECTLY
        async function loadUserEvents() {
            try {
                const { data: events, error } = await supabase
                    .from('events')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .order('created_at', { ascending: false });

                if (error) throw error;

                const container = document.getElementById('eventsContainer');
                
                if (!events || events.length === 0) {
                    container.innerHTML = `
                        <div class="bg-white rounded-lg card-shadow p-8 text-center">
                            <div class="text-gray-400 text-6xl mb-4">📅</div>
                            <h3 class="text-xl font-semibold mb-2 text-gray-800">Nenhum evento criado</h3>
                            <p class="text-gray-600 mb-4">Crie seu primeiro evento para começar a receber confirmações de presença.</p>
                            <button onclick="showCreateEventModal()" class="bg-purple-600 text-white px-6 py-2 rounded-md hover:bg-purple-700 transition duration-200">
                                Criar Primeiro Evento
                            </button>
                        </div>
                    `;
                    return;
                }

                // Load all data for each event
                for (const event of events) {
                    // Get confirmations
                    const { data: confirmations, error: confError } = await supabase
                        .from('confirmations')
                        .select('*')
                        .eq('event_id', event.id)
                        .order('created_at', { ascending: false });

                    if (confError) throw confError;

                    // Get selected gifts
                    const { data: selectedGifts, error: giftsError } = await supabase
                        .from('selected_gifts')
                        .select('*')
                        .eq('event_id', event.id)
                        .order('created_at', { ascending: false });

                    if (giftsError) throw giftsError;

                    event.confirmations = confirmations || [];
                    event.selectedGifts = selectedGifts || [];
                }

                container.innerHTML = events.map(event => {
                    const attending = event.confirmations.filter(c => c.will_attend);
                    const notAttending = event.confirmations.filter(c => !c.will_attend);
                    const totalCompanions = attending.reduce((sum, c) => sum + (c.companions || 0), 0);
                    const messagesWithText = event.confirmations.filter(c => c.message && c.message.trim());
                    const giftList = event.gift_list ? event.gift_list.split('\n').filter(g => g.trim()) : [];
                    
                    return `
                        <div class="bg-white rounded-lg card-shadow overflow-hidden">
                            <!-- Event Header -->
                            <div class="bg-gradient-to-r from-purple-600 to-blue-600 text-white p-6">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <h3 class="text-2xl font-bold mb-2">${event.name}</h3>
                                        <div class="space-y-1 text-purple-100">
                                            <p>📅 ${new Date(event.date).toLocaleDateString('pt-BR')}</p>
                                            ${event.location ? `<p>📍 ${event.location}</p>` : ''}
                                            ${event.time ? `<p>⏰ ${event.time}</p>` : ''}
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <div class="text-3xl font-bold">${attending.length}</div>
                                        <div class="text-sm text-purple-100">confirmações</div>
                                        ${totalCompanions > 0 ? `<div class="text-sm text-purple-200">+${totalCompanions} acompanhantes</div>` : ''}
                                    </div>
                                </div>
                                ${event.description ? `<p class="mt-3 text-purple-100">${event.description}</p>` : ''}
                            </div>

                            <div class="p-6 space-y-6">
                                <!-- Links Section -->
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div class="bg-purple-50 p-4 rounded-lg">
                                        <div class="text-sm font-medium text-purple-800 mb-2">🔗 Com Acompanhantes</div>
                                        <div class="bg-white p-3 rounded border text-xs font-mono break-all select-all cursor-text">
                                            ${window.location.origin}${window.location.pathname}?event=${event.id}&companions=true
                                        </div>
                                    </div>
                                    <div class="bg-blue-50 p-4 rounded-lg">
                                        <div class="text-sm font-medium text-blue-800 mb-2">🔗 Sem Acompanhantes</div>
                                        <div class="bg-white p-3 rounded border text-xs font-mono break-all select-all cursor-text">
                                            ${window.location.origin}${window.location.pathname}?event=${event.id}&companions=false
                                        </div>
                                    </div>
                                </div>

                                <!-- Statistics Cards -->
                                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                                    <div class="stats-card bg-green-50 p-4 rounded-lg text-center border border-green-200">
                                        <div class="text-2xl font-bold text-green-600">${attending.length}</div>
                                        <div class="text-sm text-green-700">Confirmados</div>
                                        ${totalCompanions > 0 ? `<div class="text-xs text-green-600">+${totalCompanions} acompanhantes</div>` : ''}
                                    </div>
                                    <div class="stats-card bg-red-50 p-4 rounded-lg text-center border border-red-200">
                                        <div class="text-2xl font-bold text-red-600">${notAttending.length}</div>
                                        <div class="text-sm text-red-700">Não comparecerão</div>
                                    </div>
                                    <div class="stats-card bg-blue-50 p-4 rounded-lg text-center border border-blue-200">
                                        <div class="text-2xl font-bold text-blue-600">${messagesWithText.length}</div>
                                        <div class="text-sm text-blue-700">Mensagens</div>
                                    </div>
                                    <div class="stats-card bg-orange-50 p-4 rounded-lg text-center border border-orange-200">
                                        <div class="text-2xl font-bold text-orange-600">${event.selectedGifts.length}</div>
                                        <div class="text-sm text-orange-700">Presentes escolhidos</div>
                                    </div>
                                </div>

                                <!-- Confirmations Section -->
                                ${event.confirmations.length > 0 ? `
                                    <div class="border rounded-lg p-4">
                                        <h4 class="font-semibold text-gray-800 mb-4 flex items-center">
                                            <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded text-sm mr-2">${event.confirmations.length}</span>
                                            Confirmações de Presença
                                        </h4>
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                            ${attending.length > 0 ? `
                                                <div class="bg-green-50 p-3 rounded">
                                                    <h5 class="font-medium text-green-800 mb-2">✅ Confirmados (${attending.length})</h5>
                                                    <div class="space-y-2 max-h-40 overflow-y-auto">
                                                        ${attending.map(conf => `
                                                            <div class="bg-white p-2 rounded border text-sm">
                                                                <div class="font-medium">${conf.guest_name}</div>
                                                                ${conf.guest_email ? `<div class="text-gray-600 text-xs">${conf.guest_email}</div>` : ''}
                                                                ${conf.companions > 0 ? `<div class="text-green-600 text-xs">+${conf.companions} acompanhante(s)</div>` : ''}
                                                            </div>
                                                        `).join('')}
                                                    </div>
                                                </div>
                                            ` : ''}
                                            ${notAttending.length > 0 ? `
                                                <div class="bg-red-50 p-3 rounded">
                                                    <h5 class="font-medium text-red-800 mb-2">❌ Não comparecerão (${notAttending.length})</h5>
                                                    <div class="space-y-2 max-h-40 overflow-y-auto">
                                                        ${notAttending.map(conf => `
                                                            <div class="bg-white p-2 rounded border text-sm">
                                                                <div class="font-medium">${conf.guest_name}</div>
                                                                ${conf.guest_email ? `<div class="text-gray-600 text-xs">${conf.guest_email}</div>` : ''}
                                                            </div>
                                                        `).join('')}
                                                    </div>
                                                </div>
                                            ` : ''}
                                        </div>
                                    </div>
                                ` : `
                                    <div class="border rounded-lg p-4 text-center text-gray-500">
                                        <p>Nenhuma confirmação recebida ainda</p>
                                    </div>
                                `}

                                <!-- Messages Section -->
                                ${messagesWithText.length > 0 ? `
                                    <div class="border rounded-lg p-4">
                                        <h4 class="font-semibold text-gray-800 mb-4 flex items-center">
                                            <span class="bg-green-100 text-green-800 px-2 py-1 rounded text-sm mr-2">${messagesWithText.length}</span>
                                            Mensagens dos Convidados
                                        </h4>
                                        <div class="space-y-3 max-h-60 overflow-y-auto">
                                            ${messagesWithText.map(conf => `
                                                <div class="bg-gray-50 p-3 rounded border-l-4 ${conf.will_attend ? 'border-green-500' : 'border-red-500'}">
                                                    <div class="flex justify-between items-start mb-1">
                                                        <span class="font-medium text-sm">${conf.guest_name}</span>
                                                        <span class="text-xs text-gray-500">${new Date(conf.created_at).toLocaleDateString('pt-BR')}</span>
                                                    </div>
                                                    <p class="text-gray-700 text-sm italic">"${conf.message}"</p>
                                                    <div class="text-xs text-gray-500 mt-1">
                                                        ${conf.will_attend ? '✅ Confirmado' : '❌ Não comparecerá'}
                                                        ${conf.companions > 0 ? ` • +${conf.companions} acompanhante(s)` : ''}
                                                    </div>
                                                </div>
                                            `).join('')}
                                        </div>
                                    </div>
                                ` : ''}

                                <!-- Gifts Section -->
                                ${giftList.length > 0 || event.iban ? `
                                    <div class="border rounded-lg p-4">
                                        <h4 class="font-semibold text-gray-800 mb-4 flex items-center">
                                            <span class="bg-orange-100 text-orange-800 px-2 py-1 rounded text-sm mr-2">${event.selectedGifts.length}</span>
                                            Lista de Presentes
                                        </h4>
                                        
                                        ${event.iban ? `
                                            <div class="bg-green-50 border border-green-200 rounded-lg p-3 mb-4">
                                                <h5 class="font-medium text-green-800 mb-2">💰 Presente em dinheiro</h5>
                                                <p class="text-sm text-green-700 mb-2">${event.iban_message || 'Sua contribuição é muito importante para nós!'}</p>
                                                <div class="bg-white p-2 rounded border font-mono text-sm">
                                                    ${event.iban}
                                                </div>
                                            </div>
                                        ` : ''}

                                        ${event.selectedGifts.length > 0 ? `
                                            <div class="mb-4">
                                                <h5 class="font-medium text-purple-800 mb-2">🎁 Presentes Escolhidos</h5>
                                                <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                                                    ${event.selectedGifts.map(gift => `
                                                        <div class="bg-purple-50 p-2 rounded border border-purple-200 text-sm">
                                                            <div class="font-medium">${gift.gift}</div>
                                                            <div class="text-purple-600 text-xs">Por: ${gift.guest_name}</div>
                                                        </div>
                                                    `).join('')}
                                                </div>
                                            </div>
                                        ` : ''}

                                        ${giftList.length > 0 ? `
                                            <div>
                                                <h5 class="font-medium text-gray-800 mb-2">📋 Lista Completa</h5>
                                                <div class="grid grid-cols-1 md:grid-cols-2 gap-2 max-h-40 overflow-y-auto">
                                                    ${giftList.map(gift => {
                                                        const isSelected = event.selectedGifts.some(sg => sg.gift === gift.trim());
                                                        return `
                                                            <div class="p-2 rounded border text-sm ${isSelected ? 'bg-green-100 border-green-300' : 'bg-gray-50 border-gray-200'}">
                                                                <span>${gift.trim()}</span>
                                                                ${isSelected ? '<span class="text-green-600 text-xs ml-2">✓ Escolhido</span>' : '<span class="text-gray-400 text-xs ml-2">Disponível</span>'}
                                                            </div>
                                                        `;
                                                    }).join('')}
                                                </div>
                                            </div>
                                        ` : ''}
                                    </div>
                                ` : ''}

                                <!-- Action Buttons -->
                                <div class="flex flex-wrap gap-2 justify-between items-center pt-4 border-t">
                                    <div class="flex flex-wrap gap-2">
                                        <button onclick="downloadReport(${event.id})" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 transition duration-200 text-sm">
                                            📄 Relatório
                                        </button>
                                        <button onclick="editEvent(${event.id})" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600 transition duration-200 text-sm">
                                            ✏️ Editar
                                        </button>
                                    </div>
                                    <div class="text-xs text-gray-500">
                                        Criado em ${new Date(event.created_at).toLocaleDateString('pt-BR')}
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('Error loading user events:', error);
                document.getElementById('eventsContainer').innerHTML = `
                    <div class="bg-red-50 border border-red-300 rounded-lg p-6 text-center">
                        <p class="text-red-600">Erro ao carregar eventos. Tente novamente.</p>
                    </div>
                `;
            }
        }

        // Event creation functions
        function showCreateEventModal() {
            document.getElementById('createEventModal').classList.remove('hidden');
        }

        function hideCreateEventModal() {
            document.getElementById('createEventModal').classList.add('hidden');
            document.getElementById('createEventForm').reset();
        }

        async function handleCreateEvent(e) {
            e.preventDefault();
            
            try {
                const eventData = {
                    user_id: currentUser.id,
                    name: document.getElementById('eventName').value,
                    date: document.getElementById('eventDate').value,
                    confirmation_deadline: document.getElementById('confirmationDeadline').value || null,
                    location: document.getElementById('eventLocation').value || null,
                    time: document.getElementById('eventTime').value || null,
                    description: document.getElementById('eventDescription').value || null,
                    gift_list: document.getElementById('giftList').value || null,
                    iban: document.getElementById('iban').value || null,
                    iban_message: document.getElementById('ibanMessage').value || null,
                    allow_duplicate_gifts: document.getElementById('allowDuplicateGifts').checked
                };

                const { data, error } = await supabase
                    .from('events')
                    .insert([eventData])
                    .select();

                if (error) throw error;

                hideCreateEventModal();
                loadUserEvents();
                showNotification('Evento criado com sucesso!', 'success');
            } catch (error) {
                console.error('Error creating event:', error);
                showNotification('Erro ao criar evento. Tente novamente.', 'error');
            }
        }

        // Modal functions
        function showAboutModal() {
            document.getElementById('aboutModal').classList.remove('hidden');
        }

        function showServicesModal() {
            document.getElementById('servicesModal').classList.remove('hidden');
        }

        function showContactModal() {
            document.getElementById('contactModal').classList.remove('hidden');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');
        }

        function showGuestLogin() {
            // Hide guest page and show login
            document.getElementById('guestPage').classList.add('hidden');
            document.getElementById('guestHeader').classList.add('hidden');
            showLoginScreen();
        }

        // Guest page functions
        async function loadGuestPage(eventId, withCompanions) {
            try {
                // Load event from Supabase
                const { data: event, error } = await supabase
                    .from('events')
                    .select('*')
                    .eq('id', eventId)
                    .single();

                if (error || !event) {
                    document.getElementById('guestPage').innerHTML = `
                        <div class="pt-20 p-4">
                            <div class="max-w-md mx-auto bg-white rounded-lg card-shadow p-8 text-center">
                                <div class="text-red-500 text-6xl mb-4">❌</div>
                                <h2 class="text-2xl font-bold mb-4 text-gray-800">Evento não encontrado</h2>
                                <p class="text-gray-600">O evento que você está procurando não existe ou foi removido.</p>
                                <p class="text-sm text-gray-500 mt-4">Verifique se o link está correto ou entre em contacto com o organizador do evento.</p>
                            </div>
                        </div>
                    `;
                    document.getElementById('guestPage').classList.remove('hidden');
                    document.getElementById('guestHeader').classList.remove('hidden');
                    return;
                }

                currentEvent = event;
                document.getElementById('guestPage').classList.remove('hidden');
                document.getElementById('guestHeader').classList.remove('hidden');
                
                // Load event header
                loadEventHeader(event);
                
                // Load countdown
                loadCountdown(event);
                
                // Load confirmation form
                await loadConfirmationForm(event, withCompanions);
            } catch (error) {
                console.error('Error loading guest page:', error);
                document.getElementById('guestPage').innerHTML = `
                    <div class="pt-20 p-4">
                        <div class="max-w-md mx-auto bg-white rounded-lg card-shadow p-8 text-center">
                            <div class="text-red-500 text-6xl mb-4">❌</div>
                            <h2 class="text-2xl font-bold mb-4 text-gray-800">Erro ao carregar evento</h2>
                            <p class="text-gray-600">Ocorreu um erro ao carregar o evento. Tente novamente mais tarde.</p>
                        </div>
                    </div>
                `;
                document.getElementById('guestPage').classList.remove('hidden');
                document.getElementById('guestHeader').classList.remove('hidden');
            }
        }

        function loadEventHeader(event) {
            const container = document.getElementById('eventHeader');
            container.innerHTML = `
                <h1 class="text-4xl font-bold text-gray-800 mb-2">${event.name}</h1>
                <div class="text-xl text-gray-600 mb-4">
                    📅 ${new Date(event.date).toLocaleDateString('pt-BR', { 
                        weekday: 'long', 
                        year: 'numeric', 
                        month: 'long', 
                        day: 'numeric' 
                    })}
                    ${event.time ? `⏰ ${event.time}` : ''}
                </div>
                ${event.location ? `<div class="text-lg text-gray-600 mb-4">📍 ${event.location}</div>` : ''}
                ${event.description ? `<div class="text-gray-700 mb-4">${event.description}</div>` : ''}
            `;
        }

        function loadCountdown(event) {
            const container = document.getElementById('countdownContainer');
            
            if (!event.confirmation_deadline) {
                container.innerHTML = '';
                return;
            }

            const deadline = new Date(event.confirmation_deadline);
            const now = new Date();
            
            if (now > deadline) {
                container.innerHTML = `
                    <div class="bg-red-100 border border-red-300 rounded-lg p-4 mb-4">
                        <div class="text-red-600 font-semibold">⏰ Prazo para confirmação expirado</div>
                        <div class="text-red-500">O prazo para confirmação de presença era até ${deadline.toLocaleDateString('pt-BR')}</div>
                    </div>
                `;
                return;
            }

            // Start countdown timer
            updateCountdown(deadline, container);
            setInterval(() => updateCountdown(deadline, container), 1000);
        }

        function updateCountdown(deadline, container) {
            const now = new Date();
            const diff = deadline - now;
            
            if (diff <= 0) {
                container.innerHTML = `
                    <div class="bg-red-100 border border-red-300 rounded-lg p-4 mb-4">
                        <div class="text-red-600 font-semibold">⏰ Prazo expirado</div>
                    </div>
                `;
                return;
            }

            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((diff % (1000 * 60)) / 1000);

            container.innerHTML = `
                <div class="bg-yellow-50 border border-yellow-300 rounded-lg p-4 mb-4">
                    <div class="text-yellow-800 font-semibold mb-2">⏰ Tempo restante para confirmação</div>
                    <div class="grid grid-cols-4 gap-2 text-center">
                        <div class="countdown-item rounded-lg p-2">
                            <div class="text-2xl font-bold text-yellow-800">${days}</div>
                            <div class="text-sm text-yellow-600">dias</div>
                        </div>
                        <div class="countdown-item rounded-lg p-2">
                            <div class="text-2xl font-bold text-yellow-800">${hours}</div>
                            <div class="text-sm text-yellow-600">horas</div>
                        </div>
                        <div class="countdown-item rounded-lg p-2">
                            <div class="text-2xl font-bold text-yellow-800">${minutes}</div>
                            <div class="text-sm text-yellow-600">min</div>
                        </div>
                        <div class="countdown-item rounded-lg p-2">
                            <div class="text-2xl font-bold text-yellow-800">${seconds}</div>
                            <div class="text-sm text-yellow-600">seg</div>
                        </div>
                    </div>
                </div>
            `;
        }

        async function loadConfirmationForm(event, withCompanions) {
            const container = document.getElementById('confirmationForm');
            
            try {
                // Check if user already confirmed using session storage
                const guestId = sessionStorage.getItem(`guest_${event.id}`);
                
                if (guestId) {
                    const { data: existingConfirmation, error } = await supabase
                        .from('confirmations')
                        .select('*')
                        .eq('event_id', event.id)
                        .eq('guest_id', guestId)
                        .single();

                    if (!error && existingConfirmation) {
                        showConfirmationResult(existingConfirmation, withCompanions);
                        return;
                    }
                }

                container.innerHTML = `
                    <form id="guestConfirmationForm" class="space-y-4">
                        <h3 class="text-2xl font-semibold mb-4 text-gray-800">Confirme sua presença</h3>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Seu nome *</label>
                            <input type="text" id="guestName" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Email (opcional)</label>
                            <input type="email" id="guestEmail" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Você irá comparecer? *</label>
                            <div class="space-y-2">
                                <label class="flex items-center">
                                    <input type="radio" name="attendance" value="yes" required class="mr-2">
                                    <span>✅ Sim, estarei presente</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="radio" name="attendance" value="no" required class="mr-2">
                                    <span>❌ Não poderei comparecer</span>
                                </label>
                            </div>
                        </div>
                        
                        ${withCompanions ? `
                            <div id="companionsSection" class="hidden">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Quantos acompanhantes?</label>
                                <select id="companionsCount" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
                                    <option value="0">Nenhum acompanhante</option>
                                    <option value="1">1 acompanhante</option>
                                    <option value="2">2 acompanhantes</option>
                                    <option value="3">3 acompanhantes</option>
                                    <option value="4">4 acompanhantes</option>
                                    <option value="5">5+ acompanhantes</option>
                                </select>
                            </div>
                        ` : ''}
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Mensagem (opcional)</label>
                            <textarea id="guestMessage" rows="3" placeholder="Deixe uma mensagem carinhosa..." class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500"></textarea>
                        </div>
                        
                        <button type="submit" class="w-full bg-purple-600 text-white py-3 rounded-md hover:bg-purple-700 transition duration-200 font-semibold">
                            Confirmar Presença
                        </button>
                    </form>
                `;

                // Setup form listeners
                const form = document.getElementById('guestConfirmationForm');
                const attendanceRadios = form.querySelectorAll('input[name="attendance"]');
                const companionsSection = document.getElementById('companionsSection');

                attendanceRadios.forEach(radio => {
                    radio.addEventListener('change', function() {
                        if (withCompanions && companionsSection) {
                            if (this.value === 'yes') {
                                companionsSection.classList.remove('hidden');
                            } else {
                                companionsSection.classList.add('hidden');
                            }
                        }
                    });
                });

                form.addEventListener('submit', function(e) {
                    e.preventDefault();
                    handleGuestConfirmation(event, withCompanions);
                });
            } catch (error) {
                console.error('Error loading confirmation form:', error);
                container.innerHTML = `
                    <div class="bg-red-50 border border-red-300 rounded-lg p-6 text-center">
                        <p class="text-red-600">Erro ao carregar formulário. Tente novamente.</p>
                    </div>
                `;
            }
        }

        async function handleGuestConfirmation(event, withCompanions) {
            try {
                const form = document.getElementById('guestConfirmationForm');
                const formData = new FormData(form);
                
                const guestId = Date.now().toString();
                const willAttend = formData.get('attendance') === 'yes';
                
                const confirmation = {
                    event_id: event.id,
                    guest_id: guestId,
                    guest_name: document.getElementById('guestName').value,
                    guest_email: document.getElementById('guestEmail').value || null,
                    will_attend: willAttend,
                    companions: withCompanions && willAttend ? 
                        parseInt(document.getElementById('companionsCount').value) : 0,
                    message: document.getElementById('guestMessage').value || null
                };

                const { data, error } = await supabase
                    .from('confirmations')
                    .insert([confirmation])
                    .select()
                    .single();

                if (error) throw error;

                // Save guest ID for persistence
                sessionStorage.setItem(`guest_${event.id}`, guestId);

                // Also save message separately if provided
                if (confirmation.message) {
                    await supabase.from('messages').insert([{
                        event_id: event.id,
                        guest_id: guestId,
                        guest_name: confirmation.guest_name,
                        message: confirmation.message
                    }]);
                }

                showConfirmationResult(data, withCompanions);
            } catch (error) {
                console.error('Error saving confirmation:', error);
                showNotification('Erro ao salvar confirmação. Tente novamente.', 'error');
            }
        }

        function showConfirmationResult(confirmation, withCompanions) {
            const container = document.getElementById('confirmationForm');
            
            if (confirmation.will_attend) {
                container.innerHTML = `
                    <div class="bg-green-50 border border-green-300 rounded-lg p-6">
                        <div class="text-green-600 text-4xl mb-4">✅</div>
                        <h3 class="text-2xl font-semibold text-green-800 mb-2">Presença confirmada!</h3>
                        <p class="text-green-700 mb-4">Obrigado por confirmar, ${confirmation.guest_name}!</p>
                        ${confirmation.companions > 0 ? `<p class="text-green-600">Você confirmou ${confirmation.companions} acompanhante(s)</p>` : ''}
                        
                        <div class="mt-4 space-y-2">
                            <button onclick="showGiftSelection()" class="w-full bg-purple-600 text-white py-2 rounded-md hover:bg-purple-700 transition duration-200">
                                Escolher presente
                            </button>
                            <button onclick="editConfirmation()" class="w-full bg-gray-500 text-white py-2 rounded-md hover:bg-gray-600 transition duration-200">
                                Editar confirmação
                            </button>
                        </div>
                    </div>
                `;
            } else {
                container.innerHTML = `
                    <div class="bg-red-50 border border-red-300 rounded-lg p-6">
                        <div class="text-red-600 text-4xl mb-4">❌</div>
                        <h3 class="text-2xl font-semibold text-red-800 mb-2">Que pena!</h3>
                        <p class="text-red-700 mb-4">Sentiremos sua falta, ${confirmation.guest_name}.</p>
                        
                        <div class="mt-4 space-y-2">
                            <button onclick="editConfirmation()" class="w-full bg-gray-500 text-white py-2 rounded-md hover:bg-gray-600 transition duration-200">
                                Editar confirmação
                            </button>
                        </div>
                    </div>
                `;
            }
        }

        async function editConfirmation() {
            try {
                const guestId = sessionStorage.getItem(`guest_${currentEvent.id}`);
                
                if (guestId) {
                    // Remove existing confirmation from Supabase
                    await supabase
                        .from('confirmations')
                        .delete()
                        .eq('event_id', currentEvent.id)
                        .eq('guest_id', guestId);

                    // Remove message if exists
                    await supabase
                        .from('messages')
                        .delete()
                        .eq('event_id', currentEvent.id)
                        .eq('guest_id', guestId);
                }
                
                // Reload confirmation form
                const urlParams = new URLSearchParams(window.location.search);
                const withCompanions = urlParams.get('companions') === 'true' || window.location.pathname.includes('com-acompanhantes');
                await loadConfirmationForm(currentEvent, withCompanions);
            } catch (error) {
                console.error('Error editing confirmation:', error);
                showNotification('Erro ao editar confirmação. Tente novamente.', 'error');
            }
        }

        async function showGiftSelection() {
            const container = document.getElementById('giftSelection');
            container.classList.remove('hidden');
            
            if (!currentEvent.gift_list && !currentEvent.iban) {
                container.innerHTML = `
                    <div class="bg-gray-50 border border-gray-300 rounded-lg p-6 text-center">
                        <h3 class="text-xl font-semibold text-gray-800 mb-2">Lista de presentes</h3>
                        <p class="text-gray-600">Os organizadores não disponibilizaram uma lista de presentes.</p>
                    </div>
                `;
                return;
            }
            
            try {
                const giftList = currentEvent.gift_list ? currentEvent.gift_list.split('\n').filter(g => g.trim()) : [];
                
                // Get selected gifts from Supabase
                const { data: selectedGifts, error } = await supabase
                    .from('selected_gifts')
                    .select('*')
                    .eq('event_id', currentEvent.id);

                if (error) throw error;

                const guestId = sessionStorage.getItem(`guest_${currentEvent.id}`);
                const userSelectedGift = selectedGifts.find(g => g.guest_id === guestId);
                
                let giftHTML = '';
                
                if (currentEvent.iban) {
                    giftHTML += `
                        <div class="bg-green-50 border border-green-300 rounded-lg p-4 mb-4">
                            <h4 class="font-semibold text-green-800 mb-2">💰 Presente em dinheiro</h4>
                            <p class="text-sm text-green-700 mb-2">${currentEvent.iban_message || 'Sua contribuição é muito importante para nós!'}</p>
                            <div class="bg-white p-3 rounded border">
                                <p class="font-mono text-sm">${currentEvent.iban}</p>
                            </div>
                        </div>
                    `;
                }
                
                if (giftList.length > 0) {
                    giftHTML += `
                        <div class="grid gap-3">
                            ${giftList.map((gift, index) => {
                                const isSelected = selectedGifts.some(g => g.gift === gift.trim());
                                const isSelectedByUser = userSelectedGift && userSelectedGift.gift === gift.trim();
                                const canSelect = !isSelected || currentEvent.allow_duplicate_gifts || isSelectedByUser;
                                
                                return `
                                    <div class="border rounded-lg p-3 ${isSelectedByUser ? 'bg-purple-50 border-purple-300' : isSelected ? 'bg-gray-100 border-gray-300' : 'bg-white border-gray-200'}">
                                        <div class="flex justify-between items-center">
                                            <span class="text-gray-800">${gift.trim()}</span>
                                            ${canSelect ? `
                                                <button onclick="selectGift('${gift.trim().replace(/'/g, "\\'")}', '${guestId}')" class="px-3 py-1 text-sm rounded ${isSelectedByUser ? 'bg-purple-600 text-white' : 'bg-purple-100 text-purple-600 hover:bg-purple-200'} transition duration-200">
                                                    ${isSelectedByUser ? 'Selecionado' : 'Escolher'}
                                                </button>
                                            ` : `
                                                <span class="text-sm text-gray-500">Já escolhido</span>
                                            `}
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    `;
                }
                
                container.innerHTML = `
                    <div class="bg-purple-50 border border-purple-300 rounded-lg p-6">
                        <h3 class="text-xl font-semibold text-purple-800 mb-4">🎁 Lista de presentes</h3>
                        ${userSelectedGift ? `
                            <div class="bg-white p-4 rounded-lg mb-4">
                                <p class="text-green-600 font-semibold">✅ Você escolheu: ${userSelectedGift.gift}</p>
                            </div>
                        ` : ''}
                        ${giftHTML}
                    </div>
                `;
            } catch (error) {
                console.error('Error loading gift selection:', error);
                container.innerHTML = `
                    <div class="bg-red-50 border border-red-300 rounded-lg p-6 text-center">
                        <p class="text-red-600">Erro ao carregar lista de presentes.</p>
                    </div>
                `;
            }
        }

        async function selectGift(giftName, guestId) {
            try {
                // Get guest name from confirmation
                const { data: confirmation, error: confError } = await supabase
                    .from('confirmations')
                    .select('guest_name')
                    .eq('event_id', currentEvent.id)
                    .eq('guest_id', guestId)
                    .single();

                if (confError) throw confError;

                // Remove any previous selection by this user for this event
                await supabase
                    .from('selected_gifts')
                    .delete()
                    .eq('event_id', currentEvent.id)
                    .eq('guest_id', guestId);

                // Add new selection
                const { error } = await supabase
                    .from('selected_gifts')
                    .insert([{
                        event_id: currentEvent.id,
                        guest_id: guestId,
                        guest_name: confirmation.guest_name,
                        gift: giftName
                    }]);

                if (error) throw error;

                // Refresh gift selection display
                showGiftSelection();
            } catch (error) {
                console.error('Error selecting gift:', error);
                showNotification('Erro ao selecionar presente. Tente novamente.', 'error');
            }
        }

        async function downloadReport(eventId) {
            try {
                showNotification('Gerando relatório...', 'info');

                // Get event data
                const { data: event, error: eventError } = await supabase
                    .from('events')
                    .select('*')
                    .eq('id', eventId)
                    .single();

                if (eventError) throw eventError;

                // Get confirmations
                const { data: confirmations, error: confError } = await supabase
                    .from('confirmations')
                    .select('*')
                    .eq('event_id', eventId)
                    .order('created_at', { ascending: false });

                if (confError) throw confError;

                // Get selected gifts
                const { data: selectedGifts, error: giftsError } = await supabase
                    .from('selected_gifts')
                    .select('*')
                    .eq('event_id', eventId);

                if (giftsError) throw giftsError;

                // Generate text report
                const attending = confirmations.filter(c => c.will_attend);
                const notAttending = confirmations.filter(c => !c.will_attend);
                const totalCompanions = attending.reduce((sum, c) => sum + (c.companions || 0), 0);

                let reportText = `RELATÓRIO DO EVENTO: ${event.name}\n`;
                reportText += `${'='.repeat(50)}\n\n`;
                
                reportText += `DETALHES DO EVENTO:\n`;
                reportText += `Data: ${new Date(event.date).toLocaleDateString('pt-BR')}\n`;
                if (event.location) reportText += `Local: ${event.location}\n`;
                if (event.time) reportText += `Horário: ${event.time}\n`;
                if (event.description) reportText += `Descrição: ${event.description}\n`;
                reportText += `\n`;

                reportText += `ESTATÍSTICAS:\n`;
                reportText += `Confirmados: ${attending.length} pessoas + ${totalCompanions} acompanhantes\n`;
                reportText += `Não comparecerão: ${notAttending.length} pessoas\n`;
                reportText += `Total de respostas: ${confirmations.length}\n\n`;

                if (attending.length > 0) {
                    reportText += `LISTA DE CONFIRMADOS (${attending.length}):\n`;
                    reportText += `${'-'.repeat(30)}\n`;
                    attending.forEach((conf, index) => {
                        reportText += `${index + 1}. ${conf.guest_name}`;
                        if (conf.companions > 0) reportText += ` (+${conf.companions} acompanhante${conf.companions > 1 ? 's' : ''})`;
                        if (conf.guest_email) reportText += ` - ${conf.guest_email}`;
                        reportText += `\n`;
                    });
                    reportText += `\n`;
                }

                if (notAttending.length > 0) {
                    reportText += `NÃO COMPARECERÃO (${notAttending.length}):\n`;
                    reportText += `${'-'.repeat(30)}\n`;
                    notAttending.forEach((conf, index) => {
                        reportText += `${index + 1}. ${conf.guest_name}`;
                        if (conf.guest_email) reportText += ` - ${conf.guest_email}`;
                        reportText += `\n`;
                    });
                    reportText += `\n`;
                }

                if (selectedGifts.length > 0) {
                    reportText += `PRESENTES ESCOLHIDOS (${selectedGifts.length}):\n`;
                    reportText += `${'-'.repeat(30)}\n`;
                    selectedGifts.forEach((gift, index) => {
                        reportText += `${index + 1}. ${gift.gift} - ${gift.guest_name}\n`;
                    });
                    reportText += `\n`;
                }

                // Show report in modal
                showReportModal(reportText, event.name);

            } catch (error) {
                console.error('Error generating report:', error);
                showNotification('Erro ao gerar relatório.', 'error');
            }
        }

        function showReportModal(reportText, eventName) {
            // Create modal if it doesn't exist
            let modal = document.getElementById('reportModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'reportModal';
                modal.className = 'hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50';
                modal.innerHTML = `
                    <div class="bg-white rounded-lg p-6 w-full max-w-4xl max-h-[90vh] overflow-y-auto">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-2xl font-bold text-gray-800">Relatório do Evento</h2>
                            <button onclick="closeModal('reportModal')" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
                        </div>
                        <div class="mb-4">
                            <button onclick="selectAllReport()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 transition duration-200 mr-2">
                                Selecionar Tudo
                            </button>
                            <span class="text-sm text-gray-600">Pressione Ctrl+C (ou Cmd+C no Mac) para copiar</span>
                        </div>
                        <div id="reportContent" class="bg-gray-50 p-4 rounded border font-mono text-sm whitespace-pre-wrap select-all cursor-text max-h-96 overflow-y-auto">
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            }

            document.getElementById('reportContent').textContent = reportText;
            modal.classList.remove('hidden');
        }

        function selectAllReport() {
            const reportContent = document.getElementById('reportContent');
            const range = document.createRange();
            range.selectNodeContents(reportContent);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            showNotification('Texto selecionado! Pressione Ctrl+C para copiar.', 'info');
        }

        function editEvent(eventId) {
            showNotification('Funcionalidade de edição será implementada em breve!', 'info');
        }
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'973cc867010977d9',t:'MTc1NTk3NDg5Mi4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
