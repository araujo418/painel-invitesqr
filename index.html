<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AdKira ‚Äì Gerador Seguro de QR Codes</title>
  <style>
    body {
      box-sizing: border-box;
      font-family: Arial, Helvetica, sans-serif; 
      background: #f4f4f4; 
      padding: 20px; 
      max-width: 900px; 
      margin: auto;
    }
    h1 {text-align: center; color: #5c67f2; margin-bottom: 30px;}
    
    .input-section {
      background: #fff; 
      padding: 25px; 
      border: 1px solid #ddd; 
      border-radius: 10px; 
      margin: 20px 0;
      box-shadow: 0 2px 6px rgba(0, 0, 0, .05);
    }
    
    label {
      display: block;
      margin-bottom: 8px;
      font-weight: bold;
      color: #333;
    }
    
    textarea {
      width: 100%; 
      height: 150px; 
      padding: 12px; 
      font-size: 1em; 
      margin-bottom: 15px;
      border: 1px solid #ddd;
      border-radius: 8px;
      resize: vertical;
      font-family: Arial, sans-serif;
    }
    
    input[type="date"] {
      width: 100%;
      padding: 12px;
      font-size: 1em;
      border: 1px solid #ddd;
      border-radius: 8px;
      margin-bottom: 15px;
    }
    
    button {
      padding: 15px 25px; 
      font-size: 1.1em; 
      margin: 10px 5px; 
      border: none; 
      border-radius: 8px; 
      background: #5c67f2; 
      color: white; 
      cursor: pointer;
      transition: all 0.3s;
      font-weight: bold;
    }
    
    button:hover {background: #4a56e2; transform: translateY(-1px);}
    button:disabled {background: #ccc; cursor: not-allowed; transform: none;}
    
    .generate-btn {
      background: #4CAF50;
      width: 100%;
      font-size: 1.2em;
      padding: 18px;
    }
    
    .generate-btn:hover {background: #45a049;}
    
    .download-section {
      text-align: center;
      margin: 25px 0;
    }
    
    .download-btn {
      background: #FF9800;
      margin: 8px;
    }
    
    .download-btn:hover {background: #F57C00;}
    
    .clear-btn {
      background: #f44336;
    }
    
    .clear-btn:hover {background: #d32f2f;}
    
    .stats {
      background: #fff;
      padding: 20px;
      border: 1px solid #ddd;
      border-radius: 10px;
      margin: 20px 0;
      box-shadow: 0 2px 6px rgba(0, 0, 0, .05);
      text-align: center;
    }
    
    .stats h3 {
      color: #5c67f2;
      margin-bottom: 15px;
    }
    
    .counter {
      font-size: 1.5em;
      font-weight: bold;
      color: #4CAF50;
      margin: 10px 0;
    }
    
    .security-info {
      background: #e8f5e8;
      border: 1px solid #4CAF50;
      border-radius: 8px;
      padding: 15px;
      margin: 15px 0;
    }
    
    .security-info h4 {
      color: #2e7d32;
      margin: 0 0 10px 0;
    }
    
    .security-info ul {
      margin: 0;
      padding-left: 20px;
      color: #2e7d32;
    }
    
    #output {
      white-space: pre-wrap; 
      background: #fff; 
      padding: 20px; 
      border: 1px solid #ccc; 
      border-radius: 8px; 
      margin-top: 20px;
      font-family: monospace;
      font-size: 0.9em;
      max-height: 300px;
      overflow-y: auto;
    }
    
    .grid {
      display: grid; 
      grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); 
      gap: 20px; 
      margin-top: 25px;
    }
    
    .qr-box {
      background: #fff; 
      padding: 15px; 
      border: 1px solid #ddd; 
      border-radius: 10px; 
      text-align: center; 
      box-shadow: 0 2px 6px rgba(0, 0, 0, .05);
      transition: transform 0.2s;
    }
    
    .qr-box:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, .1);
    }
    
    .qr-box canvas {
      width: 130px; 
      height: 130px;
      border-radius: 4px;
    }
    
    .qr-label {
      margin-top: 10px;
      font-weight: bold;
      color: #5c67f2;
      font-size: 0.9em;
    }
    
    .qr-name {
      margin-top: 5px;
      color: #666;
      font-size: 0.8em;
      word-break: break-word;
    }
    
    .loading {
      text-align: center;
      padding: 20px;
      color: #5c67f2;
      font-style: italic;
    }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>
</head>
<body>
  <h1>üîê AdKira ‚Äì Gerador Seguro de QR Codes</h1>

  <div class="input-section">
    <label for="names">üìù Lista de Convidados (um nome por linha):</label>
    <textarea id="names" placeholder="Exemplo:
Maria Silva
Jo√£o Santos
Ana Costa
Carlos Oliveira
..."></textarea>

    <label for="validityDate">üìÖ Data do Evento:</label>
    <input type="date" id="validityDate" required />

    <button class="generate-btn" onclick="generateSecureQRCodes()">
      üîê Gerar QR Codes Seguros
    </button>
  </div>

  <div class="security-info" style="display: none;" id="securityInfo">
    <h4>üõ°Ô∏è Recursos de Seguran√ßa Ativados:</h4>
    <ul>
      <li>‚úÖ Prefixos aleat√≥rios √∫nicos para cada convidado</li>
      <li>‚úÖ Criptografia AES-256 com chave secreta</li>
      <li>‚úÖ QR Codes com fundo transparente</li>
      <li>‚úÖ Dados protegidos contra replica√ß√£o</li>
    </ul>
  </div>

  <div class="stats" style="display: none;" id="statsSection">
    <h3>üìä Estat√≠sticas</h3>
    <div class="counter" id="counter"></div>
    <div id="eventInfo"></div>
  </div>

  <div class="download-section" style="display: none;" id="downloadSection">
    <button class="download-btn" onclick="downloadTXT()">üìÑ Baixar Lista (.txt)</button>
    <button class="download-btn" onclick="downloadQRPngs()">üì¶ Baixar QR Codes (.zip)</button>
    <button class="clear-btn" onclick="clearAll()">üßπ Limpar Tudo</button>
  </div>

  <div id="output" style="display: none;"></div>
  <section id="qrContainer" class="grid"></section>

  <script>
    let listData = "";
    let qrDataList = [];
    const ENCRYPTION_KEY = "phqX3eLwSsxEnHgp";

    function generateRandomPrefix() {
      const letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
      let result = '';
      for (let i = 0; i < 3; i++) {
        result += letters.charAt(Math.floor(Math.random() * letters.length));
      }
      return result;
    }

    function encryptData(data) {
      return CryptoJS.AES.encrypt(data, ENCRYPTION_KEY).toString();
    }

    function generateSecureQRCodes() {
      const names = document.getElementById('names').value.trim().split(/\r?\n/).filter(Boolean);
      const validityDate = document.getElementById('validityDate').value.trim();

      if (!names.length) {
        alert('Por favor, insira pelo menos um nome na lista.');
        return;
      }

      if (!validityDate) {
        alert('Por favor, defina a data do evento.');
        return;
      }

      // Mostra loading
      const qrWrap = document.getElementById('qrContainer');
      qrWrap.innerHTML = '<div class="loading">üîÑ Gerando QR Codes seguros...</div>';

      // Pequeno delay para mostrar o loading
      setTimeout(() => {
        processQRGeneration(names, validityDate);
      }, 100);
    }

    function processQRGeneration(names, validityDate) {
      const usedPrefixes = new Set();
      let out = `#validade:${validityDate}\n#criptografia:AES-256\n#chave:${ENCRYPTION_KEY}\n\n`;
      let counter = 1;
      const qrWrap = document.getElementById('qrContainer');
      qrWrap.innerHTML = '';
      qrDataList = [];

      names.forEach(name => {
        // Gera prefixo aleat√≥rio √∫nico
        let prefix;
        do {
          prefix = generateRandomPrefix();
        } while (usedPrefixes.has(prefix));
        usedPrefixes.add(prefix);

        // Cria c√≥digo √∫nico
        const code = prefix + String(counter).padStart(3, '0');
        
        // Dados para criptografar
        const dataToEncrypt = JSON.stringify({
          code: code,
          name: name,
          event_date: validityDate,
          generated_at: new Date().toISOString()
        });

        // Criptografa os dados
        const encryptedData = encryptData(dataToEncrypt);
        
        // Adiciona √† lista
        out += `${code},${name}\n`;

        // Cria elemento visual
        const box = document.createElement('div');
        box.className = 'qr-box';
        
        const qrDiv = document.createElement('div');
        box.appendChild(qrDiv);
        
        const codeLabel = document.createElement('div');
        codeLabel.className = 'qr-label';
        codeLabel.textContent = code;
        box.appendChild(codeLabel);
        
        const nameLabel = document.createElement('div');
        nameLabel.className = 'qr-name';
        nameLabel.textContent = name;
        box.appendChild(nameLabel);
        
        qrWrap.appendChild(box);

        // Gera QR Code com fundo transparente
        const qr = new QRCode(qrDiv, {
          text: encryptedData,
          width: 130,
          height: 130,
          colorDark: "#000000",
          colorLight: "rgba(0,0,0,0)", // Fundo transparente
          correctLevel: QRCode.CorrectLevel.H
        });

        // Armazena dados para download
        qrDataList.push({
          code: code,
          name: name,
          canvas: qrDiv.querySelector('canvas')
        });

        counter++;
      });

      listData = out.trim();
      
      // Atualiza interface
      document.getElementById('output').textContent = listData;
      document.getElementById('output').style.display = 'block';
      document.getElementById('counter').textContent = `${names.length} convidados com QR Codes seguros gerados`;
      document.getElementById('eventInfo').textContent = `Evento: ${new Date(validityDate).toLocaleDateString('pt-BR')}`;
      
      // Mostra se√ß√µes
      document.getElementById('securityInfo').style.display = 'block';
      document.getElementById('statsSection').style.display = 'block';
      document.getElementById('downloadSection').style.display = 'block';
    }

    function downloadTXT() {
      if (!listData) {
        alert('Gere os QR Codes primeiro.');
        return;
      }
      
      const blob = new Blob([listData], { type: 'text/plain;charset=utf-8' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = `lista_convidados_${new Date().toISOString().split('T')[0]}.txt`;
      link.click();
    }

    async function downloadQRPngs() {
      if (!qrDataList.length) {
        alert('Gere os QR Codes primeiro.');
        return;
      }

      const zip = new JSZip();
      
      // Aguarda um pouco para garantir que todos os QR codes foram renderizados
      await new Promise(resolve => setTimeout(resolve, 1000));

      qrDataList.forEach((item, index) => {
        try {
          const canvas = item.canvas;
          if (canvas) {
            const dataURL = canvas.toDataURL('image/png');
            const data = dataURL.split(',')[1];
            const fileName = `${item.code}_${item.name.replace(/[^a-zA-Z0-9]/g, '_')}.png`;
            zip.file(fileName, data, { base64: true });
          }
        } catch (error) {
          console.error(`Erro ao processar QR Code ${item.code}:`, error);
        }
      });

      try {
        const blob = await zip.generateAsync({ type: 'blob' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = `qr_codes_seguros_${new Date().toISOString().split('T')[0]}.zip`;
        link.click();
      } catch (error) {
        alert('Erro ao gerar arquivo ZIP. Tente novamente.');
        console.error('Erro ZIP:', error);
      }
    }

    function clearAll() {
      if (confirm('Tem certeza que deseja limpar todos os dados?')) {
        document.getElementById('names').value = '';
        document.getElementById('validityDate').value = '';
        document.getElementById('output').textContent = '';
        document.getElementById('output').style.display = 'none';
        document.getElementById('qrContainer').innerHTML = '';
        document.getElementById('securityInfo').style.display = 'none';
        document.getElementById('statsSection').style.display = 'none';
        document.getElementById('downloadSection').style.display = 'none';
        
        listData = '';
        qrDataList = [];
      }
    }

    // Define data padr√£o como hoje
    document.getElementById('validityDate').valueAsDate = new Date();
  </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'988b7658e0ce3f1f',t:'MTc1OTQ4NDI2MS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
