<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Invites - Confirma√ß√£o de Presen√ßa</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        .font-inter { font-family: 'Inter', sans-serif; }
        
        .simple-card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
        }
        
        .btn-primary {
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 8px 16px;
            font-weight: 500;
            transition: background-color 0.2s;
        }
        
        .btn-primary:hover {
            background: #2563eb;
        }
        
        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .btn-secondary {
            background: #6b7280;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 8px 16px;
            font-weight: 500;
            transition: background-color 0.2s;
        }
        
        .btn-secondary:hover {
            background: #4b5563;
        }
        
        .btn-success {
            background: #10b981;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 8px 16px;
            font-weight: 500;
            transition: background-color 0.2s;
        }
        
        .btn-success:hover {
            background: #059669;
        }
        
        .btn-danger {
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 8px 16px;
            font-weight: 500;
            transition: background-color 0.2s;
        }
        
        .btn-danger:hover {
            background: #dc2626;
        }
        
        .simple-input {
            border: 1px solid #d1d5db;
            border-radius: 6px;
            padding: 8px 12px;
            font-size: 14px;
            transition: border-color 0.2s;
        }
        
        .simple-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .simple-input:disabled {
            background: #f9fafb;
            color: #6b7280;
            cursor: not-allowed;
        }

        .nav-tabs {
            border-bottom: 1px solid #e5e7eb;
        }
        
        .nav-tab {
            padding: 12px 24px;
            border-bottom: 2px solid transparent;
            color: #6b7280;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .nav-tab.active {
            color: #3b82f6;
            border-bottom-color: #3b82f6;
        }
        
        .nav-tab:hover {
            color: #374151;
        }

        /* Hide main content initially for guest pages */
        .guest-loading {
            display: none !important;
        }

        /* Guest page header styling */
        .guest-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 50;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(229, 231, 235, 0.8);
        }

        /* Adjust content spacing for guest pages */
        .guest-content {
            padding-top: 100px;
        }

        /* Admin dashboard header spacing */
        .admin-content {
            padding-top: 20px;
        }

        /* Emoji picker styling */
        .emoji-picker {
            display: none;
            position: absolute;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 8px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            z-index: 100;
            max-height: 200px;
            overflow-y: auto;
            width: 280px;
        }

        .emoji-picker.show {
            display: block;
        }

        .emoji-grid {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 4px;
        }

        .emoji-btn {
            padding: 8px;
            border: none;
            background: none;
            cursor: pointer;
            border-radius: 4px;
            font-size: 18px;
            transition: background-color 0.2s;
        }

        .emoji-btn:hover {
            background: #f3f4f6;
        }

        /* Response status styling */
        .response-status {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            padding: 20px;
            border-radius: 16px;
            text-align: center;
            margin-bottom: 24px;
        }

        .edit-response-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .edit-response-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        /* Clean styling for guest pages - same as main site */
        .premium-card {
            background: white;
            color: #374151;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            border: 1px solid #e5e7eb;
        }

        .premium-input {
            background: white;
            border: 1px solid #d1d5db;
            color: #374151;
        }

        .premium-input:focus {
            background: white;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .font-playfair {
            font-family: 'Playfair Display', serif;
        }

        /* Promotional link styling */
        .promo-link {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            padding: 12px 20px;
            border-radius: 50px;
            text-decoration: none;
            font-weight: 600;
            font-size: 14px;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4);
            transition: all 0.3s ease;
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .promo-link:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.6);
        }

        /* Countdown animation */
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        .countdown-pulse {
            animation: pulse 2s infinite;
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&display=swap" rel="stylesheet">
</head>
<body class="font-inter min-h-screen bg-gray-50">

    <!-- Main Container -->
    <div class="max-w-6xl mx-auto" id="main-container">
        <!-- Header -->
        <header class="bg-white border-b border-gray-200 px-6 py-4" id="main-header">
            <div class="flex justify-between items-center">
                <h1 class="text-2xl font-semibold text-gray-900">Invites</h1>
                <button onclick="showSection('login')" id="login-btn-container" class="btn-secondary text-sm">
                    Login
                </button>
            </div>
        </header>

        <!-- Navigation Tabs -->
        <nav class="nav-tabs bg-white px-6" id="main-navigation">
            <div class="flex">
                <button onclick="showSection('home')" id="nav-home" class="nav-tab active">
                    In√≠cio
                </button>
                <button onclick="showSection('create')" id="nav-create" class="nav-tab">
                    Criar Evento
                </button>
            </div>
        </nav>

        <!-- Home Section -->
        <section id="home-section" class="p-6">
            <div class="simple-card p-6">
                <h2 class="text-xl font-semibold text-gray-900 mb-6">Como Funciona</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="text-center">
                        <div class="w-10 h-10 mx-auto mb-3 bg-blue-500 rounded-lg flex items-center justify-center text-white">1</div>
                        <h3 class="font-medium mb-2 text-gray-900">Crie o Evento</h3>
                        <p class="text-sm text-gray-600">Configure os detalhes do seu evento</p>
                    </div>
                    <div class="text-center">
                        <div class="w-10 h-10 mx-auto mb-3 bg-blue-500 rounded-lg flex items-center justify-center text-white">2</div>
                        <h3 class="font-medium mb-2 text-gray-900">Compartilhe</h3>
                        <p class="text-sm text-gray-600">Envie o link para os convidados</p>
                    </div>
                    <div class="text-center">
                        <div class="w-10 h-10 mx-auto mb-3 bg-blue-500 rounded-lg flex items-center justify-center text-white">3</div>
                        <h3 class="font-medium mb-2 text-gray-900">Gerencie</h3>
                        <p class="text-sm text-gray-600">Acompanhe as confirma√ß√µes</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Create Event Site Section -->
        <section id="create-section" class="p-6 hidden">
            <div class="simple-card p-6">
                <h2 class="text-xl font-semibold text-gray-900 mb-6">Criar Novo Evento</h2>
                
                <form id="eventForm" class="space-y-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">T√≠tulo do Evento *</label>
                        <input type="text" id="eventTitle" required placeholder="Ex: Evento Corporativo 2025" class="w-full simple-input">
                    </div>

                    <!-- Configura√ß√µes -->
                    <div class="bg-gray-50 rounded-lg p-4 border">
                        <h3 class="font-medium text-gray-900 mb-3">Configura√ß√µes</h3>
                        <div class="space-y-3">
                            <label class="flex items-center">
                                <input type="checkbox" id="enableDescription" checked class="mr-2">
                                <span class="text-sm text-gray-700">Mostrar descri√ß√£o do evento</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" id="enableDeadline" checked class="mr-2">
                                <span class="text-sm text-gray-700">Definir data limite para confirma√ß√£o</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" id="enableMaxLimit" checked class="mr-2">
                                <span class="text-sm text-gray-700">Definir limite m√°ximo de confirmados</span>
                            </label>
                        </div>
                    </div>

                    <div id="descriptionField">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Descri√ß√£o *</label>
                        <textarea id="eventDescription" required placeholder="Ex: Confer√™ncia anual da empresa com apresenta√ß√µes e networking" class="w-full simple-input h-20 resize-none"></textarea>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Data do Evento *</label>
                        <input type="date" id="eventDate" required class="w-full simple-input">
                    </div>

                    <div id="deadlineField">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Data Limite para Confirma√ß√£o *</label>
                        <input type="date" id="confirmationDeadline" required class="w-full simple-input">
                    </div>

                    <div id="maxLimitField">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Limite M√°ximo de Confirmados *</label>
                        <input type="number" id="maxConfirmations" required placeholder="Ex: 100" min="1" class="w-full simple-input">
                    </div>

                    <div class="bg-gray-50 rounded-lg p-4 border">
                        <h3 class="font-medium text-gray-900 mb-3">Credenciais de Acesso</h3>
                        <div class="grid md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Usu√°rio *</label>
                                <input type="text" id="username" required placeholder="Ex: evento2025" class="w-full simple-input">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Senha *</label>
                                <input type="password" id="password" required placeholder="Senha segura" class="w-full simple-input">
                            </div>
                        </div>
                    </div>

                    <button type="submit" id="createButton" class="w-full btn-primary py-3 text-base font-medium">
                        Criar Evento
                    </button>
                </form>

                <!-- Success Message -->
                <div id="success-message" class="hidden mt-6 p-4 bg-green-50 border border-green-200 rounded-lg">
                    <h3 class="font-medium text-green-800 mb-2">Evento Criado com Sucesso!</h3>
                    <p class="text-green-700 text-sm mb-4">Links para compartilhar:</p>
                    
                    <div class="space-y-3">
                        <div class="bg-white p-3 rounded border">
                            <h4 class="font-medium text-gray-800 mb-1 text-sm">Link Completo (permite acompanhantes)</h4>
                            <code id="generated-url" class="text-xs text-blue-600 hidden"></code>
                            <div id="display-url" class="text-xs text-blue-600 font-mono mb-2"></div>
                            <button onclick="copyUrl()" class="btn-primary text-xs">
                                Copiar Link Completo
                            </button>
                        </div>
                        
                        <div class="bg-white p-3 rounded border">
                            <h4 class="font-medium text-gray-800 mb-1 text-sm">Link Sem Acompanhante</h4>
                            <div id="display-url-no-companion" class="text-xs text-orange-600 font-mono mb-2"></div>
                            <button onclick="copyUrlNoCompanion()" class="btn-secondary text-xs">
                                Copiar Link Sem Acompanhante
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Client Login Section -->
        <section id="login-section" class="p-6 hidden">
            <div class="max-w-md mx-auto guest-content">
                <div class="simple-card p-6">
                    <h2 class="text-xl font-semibold text-gray-900 mb-4">Login</h2>
                    <p class="text-sm text-gray-600 mb-6">Acesse seu painel para gerenciar seu evento</p>
                    
                    <form id="adminLoginForm" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Usu√°rio</label>
                            <input type="text" id="loginUsername" required class="w-full simple-input" placeholder="Digite seu usu√°rio">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Senha</label>
                            <input type="password" id="loginPassword" required class="w-full simple-input" placeholder="Digite sua senha">
                        </div>

                        <div id="loginError" class="text-red-600 text-sm hidden bg-red-50 p-3 rounded border border-red-200"></div>

                        <div class="flex gap-3">
                            <button type="submit" id="loginButton" class="flex-1 btn-primary py-3">
                                Acessar Painel
                            </button>
                            <button type="button" onclick="goBackFromLogin()" id="back-from-login" class="flex-1 btn-secondary py-3">
                                Voltar
                            </button>
                        </div>
                    </form>

                    <div id="master-admin-access" class="mt-6 pt-4 border-t border-gray-200">
                        <button onclick="showMasterAdminLogin()" class="w-full btn-danger py-2 text-sm">
                            Acesso Master Admin
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <!-- Master Admin Login Section -->
        <section id="master-admin-section" class="p-6 hidden">
            <div class="max-w-md mx-auto guest-content">
                <div class="simple-card p-6">
                    <h2 class="text-xl font-semibold text-gray-900 mb-4">Master Admin</h2>
                    <p class="text-sm text-gray-600 mb-6">Acesso administrativo para gerenciar todos os eventos</p>
                    
                    <form id="masterAdminForm" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">C√≥digo Master</label>
                            <input type="password" id="masterCode" required class="w-full simple-input" placeholder="Digite o c√≥digo master">
                        </div>

                        <div id="masterLoginError" class="text-red-600 text-sm hidden bg-red-50 p-3 rounded border border-red-200"></div>

                        <div class="flex gap-3">
                            <button type="submit" id="masterLoginButton" class="flex-1 btn-danger py-3">
                                Acessar
                            </button>
                            <button type="button" onclick="showSection('login')" class="flex-1 btn-secondary py-3">
                                Voltar
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </section>

        <!-- Master Admin Dashboard -->
        <section id="master-dashboard-section" class="p-6 hidden">
            <div class="simple-card p-6 mb-6">
                <div class="flex justify-between items-center mb-4">
                    <div>
                        <h2 class="text-xl font-semibold text-gray-900">Painel Master Admin</h2>
                        <p class="text-sm text-gray-600">Gerenciamento de todos os eventos</p>
                    </div>
                    <button onclick="logout()" class="btn-danger text-sm">
                        Sair
                    </button>
                </div>

                <div class="grid md:grid-cols-3 gap-4">
                    <div class="bg-blue-50 rounded-lg p-4 text-center border">
                        <div class="text-2xl font-bold text-blue-600" id="total-events">0</div>
                        <div class="text-sm text-gray-600">Total de Eventos</div>
                    </div>
                    <div class="bg-green-50 rounded-lg p-4 text-center border">
                        <div class="text-2xl font-bold text-green-600" id="total-all-guests">0</div>
                        <div class="text-sm text-gray-600">Total de Convidados</div>
                    </div>
                    <div class="bg-purple-50 rounded-lg p-4 text-center border">
                        <div class="text-2xl font-bold text-purple-600" id="total-all-messages">0</div>
                        <div class="text-sm text-gray-600">Total de Mensagens</div>
                    </div>
                </div>
            </div>

            <!-- All Events List -->
            <div class="simple-card p-6 mb-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Todos os Eventos</h3>
                
                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead>
                            <tr class="border-b">
                                <th class="text-left py-2 px-3">Evento</th>
                                <th class="text-left py-2 px-3">Usu√°rio</th>
                                <th class="text-left py-2 px-3">Senha</th>
                                <th class="text-left py-2 px-3">Data</th>
                                <th class="text-left py-2 px-3">Convidados</th>
                                <th class="text-left py-2 px-3">A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="all-events-list">
                            <!-- Events list will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Detailed Event View -->
            <div id="event-details-section" class="simple-card p-6 hidden">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold text-gray-900">Detalhes do Evento</h3>
                    <button onclick="hideEventDetails()" class="btn-secondary text-sm">
                        Voltar
                    </button>
                </div>
                
                <div id="event-details-content">
                    <!-- Event details will be loaded here -->
                </div>
            </div>
        </section>

        <!-- Admin Dashboard -->
        <section id="dashboard-section" class="p-6 hidden admin-content">
            <div class="simple-card p-6 mb-6">
                <div class="flex justify-between items-center mb-4">
                    <div>
                        <h2 class="text-xl font-semibold text-gray-900">Painel do Evento</h2>
                        <p id="event-info" class="text-sm text-gray-600"></p>
                    </div>
                    <div class="flex gap-2 flex-wrap">
                        <button onclick="copyEventUrl()" class="btn-primary text-xs">
                            Link Completo
                        </button>
                        <button onclick="copyEventUrlNoCompanion()" class="btn-secondary text-xs">
                            Link Sem Acompanhante
                        </button>
                        <button onclick="showPasswordSection()" class="btn-secondary text-xs">
                            Gerenciar Senha
                        </button>
                        <button onclick="logout()" class="btn-danger text-xs">
                            Sair
                        </button>
                    </div>
                </div>

                <div class="grid md:grid-cols-4 gap-4" id="stats-grid">
                    <div class="bg-blue-50 rounded-lg p-4 text-center border">
                        <div class="text-2xl font-bold text-blue-600" id="total-guests">0</div>
                        <div class="text-sm text-gray-600">Total de Convidados</div>
                    </div>
                    <div class="bg-green-50 rounded-lg p-4 text-center border">
                        <div class="text-2xl font-bold text-green-600" id="confirmed-guests">0</div>
                        <div class="text-sm text-gray-600">Confirmados</div>
                    </div>
                    <div class="bg-orange-50 rounded-lg p-4 text-center border" id="max-limit-stat" style="display: none;">
                        <div class="text-2xl font-bold text-orange-600" id="max-limit">0</div>
                        <div class="text-sm text-gray-600">Limite M√°ximo</div>
                    </div>
                    <div class="bg-purple-50 rounded-lg p-4 text-center border" id="deadline-stat" style="display: none;">
                        <div class="text-sm font-bold text-purple-600" id="deadline-info">-</div>
                        <div class="text-sm text-gray-600">Prazo Confirma√ß√£o</div>
                    </div>
                </div>
            </div>

            <!-- Guest List -->
            <div class="simple-card p-6 mb-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold text-gray-900">Lista de Convidados</h3>
                    <button onclick="downloadGuestReport()" class="btn-success text-sm">
                        üìÑ Baixar PDF
                    </button>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead>
                            <tr class="border-b">
                                <th class="text-left py-2 px-3">Nome</th>
                                <th class="text-left py-2 px-3">Acompanhante</th>
                                <th class="text-left py-2 px-3">Status</th>
                                <th class="text-left py-2 px-3">Data</th>
                            </tr>
                        </thead>
                        <tbody id="guest-list">
                            <!-- Guest list will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Password Management -->
            <div id="password-section" class="simple-card p-6 mb-6 hidden">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Gerenciar Senha</h3>
                
                <div class="bg-gray-50 rounded-lg p-4 mb-4 border">
                    <h4 class="font-medium text-gray-900 mb-3">Informa√ß√µes Atuais</h4>
                    <div class="grid md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Usu√°rio:</label>
                            <div class="bg-white p-2 rounded border text-gray-800 font-mono text-sm" id="current-username"></div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Senha Atual:</label>
                            <div class="bg-white p-2 rounded border text-gray-800 font-mono text-sm" id="current-password"></div>
                        </div>
                    </div>
                </div>

                <form id="change-password-form" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Nova Senha *</label>
                        <input type="password" id="new-password" required placeholder="Digite a nova senha" class="w-full simple-input">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Confirmar Nova Senha *</label>
                        <input type="password" id="confirm-password" required placeholder="Confirme a nova senha" class="w-full simple-input">
                    </div>

                    <div class="flex gap-3">
                        <button type="submit" id="change-password-btn" class="btn-success py-2">
                            Alterar Senha
                        </button>
                        <button type="button" onclick="hidePasswordSection()" class="btn-secondary py-2">
                            Cancelar
                        </button>
                    </div>
                </form>
            </div>

            <!-- Messages -->
            <div class="simple-card p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Mensagens dos Convidados</h3>
                <div class="bg-blue-50 rounded-lg p-3 mb-4 border border-blue-200">
                    <p class="text-sm text-blue-700">
                        <strong>Dica:</strong> Estas mensagens tamb√©m aparecem no mural p√∫blico do seu evento.
                    </p>
                </div>
                <div id="messages-list" class="space-y-3">
                    <!-- Messages will be populated here -->
                </div>
            </div>
        </section>

        <!-- Event Site View -->
        <section id="event-site-section" class="hidden">
            <div id="event-site-content" class="pt-20">
                <!-- Event site content will be loaded here -->
            </div>
            <!-- Promotional Link (only visible on guest sites) -->
            <a href="https://wa.me/244959823409?text=Ol√°! Vi o site de eventos e gostaria de saber mais sobre como criar o meu pr√≥prio evento." 
               class="promo-link" target="_blank">
                <span>üíö</span>
                <span>Gostou? Crie o seu!</span>
            </a>
        </section>
    </div>

    <!-- Footer -->
    <footer class="text-center py-6 mt-8 border-t border-gray-200 bg-white" id="main-footer">
        <p class="text-sm text-gray-500">Copyright ¬©Invites 2025</p>
    </footer>

    <script>
        // Supabase Configuration
        const supabaseUrl = 'https://ybbhynfttwogkdsnqmvu.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InliYmh5bmZ0dHdvZ2tkc25xbXZ1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU2NzY3MDIsImV4cCI6MjA3MTI1MjcwMn0.LPMGW_OPKiwTEKhyzl_v2Snb9nVeZg0wP4Ot6zKrCn0';
        
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey, {
            auth: {
                persistSession: false
            },
            global: {
                headers: {
                    'apikey': supabaseKey,
                    'Authorization': `Bearer ${supabaseKey}`
                }
            }
        });

        let currentEvent = null;
        let currentUser = null;
        let isMasterAdmin = false;
        let countdownInterval = null;
        let userResponse = null; // Track user's RSVP response
        const MASTER_CODE = 'invites2025master';

        // Check for guest access immediately
        const urlParams = new URLSearchParams(window.location.search);
        const clienteParam = urlParams.get('cliente');

        if (clienteParam) {
            // Hide main content immediately for guest pages
            document.getElementById('main-navigation').classList.add('guest-loading');
            document.getElementById('main-footer').classList.add('guest-loading');
            // Keep header visible but modify it for guest pages
            document.querySelectorAll('section').forEach(s => s.classList.add('hidden'));
        }

        // Session Management
        function saveSession(event) {
            localStorage.setItem('eventSession', JSON.stringify(event));
        }

        function loadSession() {
            const session = localStorage.getItem('eventSession');
            return session ? JSON.parse(session) : null;
        }

        function clearSession() {
            localStorage.removeItem('eventSession');
        }

        // Navigation
        function showSection(section) {
            // Hide all sections
            document.querySelectorAll('section').forEach(s => s.classList.add('hidden'));
            
            // Show selected section
            document.getElementById(section + '-section').classList.remove('hidden');
            
            // Update navigation (only for home and create sections)
            if (section === 'home' || section === 'create') {
                document.querySelectorAll('[id^="nav-"]').forEach(btn => {
                    btn.className = 'nav-tab';
                });
                document.getElementById('nav-' + section).className = 'nav-tab active';
            }
        }

        // Fun√ß√£o para gerar URL personalizada
        function generateCustomUrl(eventTitle) {
            return eventTitle.toLowerCase()
                .replace(/[^a-z0-9\s]/g, '')
                .replace(/\s+/g, '-')
                .substring(0, 50);
        }

        // Fun√ß√£o para criar o evento no Supabase
        async function createEvent(eventData) {
            const { data, error } = await supabase
                .from('events')
                .insert({
                    username: eventData.username,
                    password: eventData.password,
                    title: eventData.eventTitle,
                    description: eventData.eventDescription,
                    event_date: eventData.eventDate,
                    confirmation_deadline: eventData.confirmationDeadline,
                    max_confirmations: eventData.maxConfirmations,
                    custom_url: eventData.customUrl,
                    enable_description: eventData.enableDescription,
                    enable_deadline: eventData.enableDeadline,
                    enable_max_limit: eventData.enableMaxLimit
                })
                .select()
                .single();

            if (error) {
                console.error('Supabase error:', error);
                throw error;
            }
            return data;
        }

        // Toggle field visibility based on checkboxes
        function setupFieldToggles() {
            const enableDescription = document.getElementById('enableDescription');
            const enableDeadline = document.getElementById('enableDeadline');
            const enableMaxLimit = document.getElementById('enableMaxLimit');
            
            const descriptionField = document.getElementById('descriptionField');
            const deadlineField = document.getElementById('deadlineField');
            const maxLimitField = document.getElementById('maxLimitField');
            
            const eventDescription = document.getElementById('eventDescription');
            const confirmationDeadline = document.getElementById('confirmationDeadline');
            const maxConfirmations = document.getElementById('maxConfirmations');

            function toggleField(checkbox, field, input) {
                if (checkbox.checked) {
                    field.style.display = 'block';
                    input.disabled = false;
                    input.required = true;
                } else {
                    field.style.display = 'none';
                    input.disabled = true;
                    input.required = false;
                    input.value = '';
                }
            }

            enableDescription.addEventListener('change', () => {
                toggleField(enableDescription, descriptionField, eventDescription);
            });

            enableDeadline.addEventListener('change', () => {
                toggleField(enableDeadline, deadlineField, confirmationDeadline);
            });

            enableMaxLimit.addEventListener('change', () => {
                toggleField(enableMaxLimit, maxLimitField, maxConfirmations);
            });
        }

        // Create Event
        document.getElementById('eventForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const createButton = document.getElementById('createButton');
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value.trim();
            const eventTitle = document.getElementById('eventTitle').value.trim();
            const eventDate = document.getElementById('eventDate').value;

            // Get checkbox states
            const enableDescription = document.getElementById('enableDescription').checked;
            const enableDeadline = document.getElementById('enableDeadline').checked;
            const enableMaxLimit = document.getElementById('enableMaxLimit').checked;

            // Get conditional fields
            const eventDescription = enableDescription ? document.getElementById('eventDescription').value.trim() : '';
            const confirmationDeadline = enableDeadline ? document.getElementById('confirmationDeadline').value : null;
            const maxConfirmations = enableMaxLimit ? document.getElementById('maxConfirmations').value : null;

            // Verificar campos obrigat√≥rios
            if (!username || !password || !eventTitle || !eventDate) {
                alert('Por favor, preencha todos os campos obrigat√≥rios.');
                return;
            }

            // Verificar campos condicionais
            if (enableDescription && !eventDescription) {
                alert('Por favor, preencha a descri√ß√£o do evento.');
                return;
            }

            if (enableDeadline && !confirmationDeadline) {
                alert('Por favor, defina a data limite para confirma√ß√£o.');
                return;
            }

            if (enableMaxLimit && !maxConfirmations) {
                alert('Por favor, defina o limite m√°ximo de confirmados.');
                return;
            }

            // Verificar se a data limite √© anterior √† data do evento (se ativada)
            if (enableDeadline && confirmationDeadline && new Date(confirmationDeadline) >= new Date(eventDate)) {
                alert('A data limite para confirma√ß√£o deve ser anterior √† data do evento.');
                return;
            }

            createButton.textContent = 'Criando...';
            createButton.disabled = true;

            // Dados do evento para serem enviados ao Supabase
            const eventData = {
                username: username,
                password: password,
                eventTitle: eventTitle,
                eventDescription: eventDescription,
                eventDate: eventDate,
                confirmationDeadline: confirmationDeadline,
                maxConfirmations: maxConfirmations ? parseInt(maxConfirmations) : null,
                customUrl: generateCustomUrl(eventTitle),
                enableDescription: enableDescription,
                enableDeadline: enableDeadline,
                enableMaxLimit: enableMaxLimit
            };

            // Enviar para o Supabase
            try {
                console.log('Enviando dados:', eventData);
                const createdEvent = await createEvent(eventData);
                console.log('Evento criado:', createdEvent);
                
                // Show success message with working URL
                const generatedUrl = `https://araujo418.github.io/painel-invitesqr/index.html?cliente=${eventData.customUrl}`;
                document.getElementById('generated-url').textContent = generatedUrl;
                
                // Show only the visible part of the URL
                const displayUrl = `araujo418.github.io/painel-invitesqr/index.html?cliente=${eventData.customUrl}`;
                document.getElementById('display-url').textContent = displayUrl;
                
                // Show the no-companion URL
                const displayUrlNoCompanion = `araujo418.github.io/painel-invitesqr/index.html?cliente=${eventData.customUrl}&companion=no`;
                document.getElementById('display-url-no-companion').textContent = displayUrlNoCompanion;
                
                document.getElementById('success-message').classList.remove('hidden');
                
                // Reset form
                document.getElementById('eventForm').reset();
                
                // Reset checkboxes to default (checked)
                document.getElementById('enableDescription').checked = true;
                document.getElementById('enableDeadline').checked = true;
                document.getElementById('enableMaxLimit').checked = true;
                
                // Show all fields again
                document.getElementById('descriptionField').style.display = 'block';
                document.getElementById('deadlineField').style.display = 'block';
                document.getElementById('maxLimitField').style.display = 'block';
                
                alert('üéâ Parab√©ns! Seu evento foi criado com sucesso!');
            } catch (error) {
                console.error('Erro completo:', error);
                let errorMessage = 'Erro ao criar o evento. ';
                
                if (error.message) {
                    errorMessage += error.message;
                } else if (error.details) {
                    errorMessage += error.details;
                } else {
                    errorMessage += 'Tente novamente.';
                }
                
                alert(errorMessage);
            } finally {
                createButton.textContent = '‚ú® Criar Evento';
                createButton.disabled = false;
            }
        });

        // Copy URL function
        function copyUrl() {
            const url = document.getElementById('generated-url').textContent;
            navigator.clipboard.writeText(url).then(() => {
                alert('Link completo copiado! (permite acompanhantes)');
            });
        }

        // Copy URL without companion function
        function copyUrlNoCompanion() {
            const baseUrl = document.getElementById('generated-url').textContent;
            const urlNoCompanion = baseUrl + '&companion=no';
            navigator.clipboard.writeText(urlNoCompanion).then(() => {
                alert('Link sem acompanhante copiado!');
            });
        }

        // Fun√ß√£o para login do administrador
        async function loginAdmin(username, password) {
            const { data, error } = await supabase
                .from('events')
                .select('*')
                .eq('username', username)
                .eq('password', password)
                .single();

            if (error) throw error;
            return data;
        }

        // Fun√ß√£o para mostrar o painel de administra√ß√£o
        function showAdminDashboard() {
            showSection('dashboard');
        }

        // Login
        document.getElementById('adminLoginForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const loginButton = document.getElementById('loginButton');
            const loginError = document.getElementById('loginError');
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;

            loginError.classList.add('hidden');
            loginButton.textContent = 'Entrando...';
            loginButton.disabled = true;

            try {
                // Realiza o login no Supabase
                const adminData = await loginAdmin(username, password);
                
                currentUser = adminData;
                currentEvent = adminData;
                saveSession(adminData);
                
                // Dados do painel
                document.getElementById('event-info').textContent = `${adminData.title} - ${formatDate(adminData.event_date)}`;

                loadDashboard();
                showAdminDashboard();
            } catch (error) {
                loginError.textContent = 'Usu√°rio ou senha incorretos.';
                loginError.classList.remove('hidden');
            } finally {
                loginButton.textContent = 'üöÄ Acessar Painel';
                loginButton.disabled = false;
            }
        });

        // Show/Hide Password Section
        function showPasswordSection() {
            document.getElementById('password-section').classList.remove('hidden');
            document.getElementById('current-username').textContent = currentEvent.username;
            document.getElementById('current-password').textContent = currentEvent.password;
        }

        function hidePasswordSection() {
            document.getElementById('password-section').classList.add('hidden');
            document.getElementById('change-password-form').reset();
        }

        // Change Password
        document.getElementById('change-password-form').addEventListener('submit', async function(e) {
            e.preventDefault();

            const newPassword = document.getElementById('new-password').value;
            const confirmPassword = document.getElementById('confirm-password').value;
            const changeBtn = document.getElementById('change-password-btn');

            if (newPassword !== confirmPassword) {
                alert('As senhas n√£o coincidem!');
                return;
            }

            if (newPassword.length < 4) {
                alert('A senha deve ter pelo menos 4 caracteres!');
                return;
            }

            changeBtn.textContent = 'Alterando...';
            changeBtn.disabled = true;

            try {
                const { error } = await supabase
                    .from('events')
                    .update({ password: newPassword })
                    .eq('id', currentEvent.id);

                if (error) throw error;

                currentEvent.password = newPassword;
                saveSession(currentEvent);
                
                alert('‚úÖ Senha alterada com sucesso!');
                hidePasswordSection();

            } catch (error) {
                console.error('Error changing password:', error);
                alert('Erro ao alterar senha. Tente novamente.');
            } finally {
                changeBtn.textContent = '‚úÖ Alterar Senha';
                changeBtn.disabled = false;
            }
        });

        // Master Admin Functions
        function showMasterAdminLogin() {
            showSection('master-admin');
        }

        // Master Admin Login
        document.getElementById('masterAdminForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const masterCode = document.getElementById('masterCode').value;
            const masterLoginButton = document.getElementById('masterLoginButton');
            const masterLoginError = document.getElementById('masterLoginError');

            masterLoginError.classList.add('hidden');
            masterLoginButton.textContent = 'Verificando...';
            masterLoginButton.disabled = true;

            try {
                if (masterCode !== MASTER_CODE) {
                    throw new Error('C√≥digo master incorreto');
                }

                isMasterAdmin = true;
                await loadMasterDashboard();
                showSection('master-dashboard');

            } catch (error) {
                masterLoginError.textContent = error.message;
                masterLoginError.classList.remove('hidden');
            } finally {
                masterLoginButton.textContent = 'üëë Acessar';
                masterLoginButton.disabled = false;
            }
        });

        // Load Master Dashboard
        async function loadMasterDashboard() {
            try {
                // Get all events
                const { data: events } = await supabase
                    .from('events')
                    .select('*')
                    .order('created_at', { ascending: false });

                // Get all RSVPs
                const { data: allRsvps } = await supabase
                    .from('rsvps')
                    .select('*');

                // Get all messages (from rsvps table where message is not null)
                const { data: allMessages } = await supabase
                    .from('rsvps')
                    .select('*')
                    .not('message', 'is', null)
                    .neq('message', '');

                // Update stats
                document.getElementById('total-events').textContent = events ? events.length : 0;
                document.getElementById('total-all-guests').textContent = allRsvps ? allRsvps.length : 0;
                document.getElementById('total-all-messages').textContent = allMessages ? allMessages.length : 0;

                // Load events list
                await loadAllEventsList(events, allRsvps);

            } catch (error) {
                console.error('Error loading master dashboard:', error);
            }
        }

        // Load All Events List
        async function loadAllEventsList(events, allRsvps) {
            const eventsList = document.getElementById('all-events-list');
            eventsList.innerHTML = '';

            if (events && events.length > 0) {
                events.forEach(event => {
                    const eventRsvps = allRsvps ? allRsvps.filter(r => r.wedding_id === event.id) : [];
                    const confirmedCount = eventRsvps.filter(r => r.attendance).length;

                    const row = document.createElement('tr');
                    row.className = 'border-b hover:bg-gray-50';
                    row.innerHTML = `
                        <td class="py-3 px-4">
                            <div class="font-semibold">${event.title}</div>
                            <div class="text-sm text-gray-500">${formatDate(event.event_date)}</div>
                        </td>
                        <td class="py-3 px-4 font-mono text-sm">${event.username}</td>
                        <td class="py-3 px-4 font-mono text-sm">${event.password}</td>
                        <td class="py-3 px-4">${formatDate(event.created_at)}</td>
                        <td class="py-3 px-4">
                            <span class="text-green-600 font-semibold">${confirmedCount}</span>
                            <span class="text-gray-400">/${eventRsvps.length}</span>
                        </td>
                        <td class="py-3 px-4">
                            <div class="flex gap-1 flex-wrap">
                                <button onclick="showEventDetails(${event.id})" class="bg-indigo-500 text-white px-2 py-1 rounded text-xs hover:bg-indigo-600">
                                    üëÅÔ∏è Ver
                                </button>
                                <button onclick="changeEventPassword(${event.id}, '${event.title}')" class="bg-blue-500 text-white px-2 py-1 rounded text-xs hover:bg-blue-600">
                                    üîë Senha
                                </button>
                                <button onclick="copyEventUrlMaster('${event.custom_url}')" class="bg-green-500 text-white px-2 py-1 rounded text-xs hover:bg-green-600">
                                    üìã Link
                                </button>
                                <button onclick="downloadEventReport(${event.id}, '${event.title}')" class="bg-purple-500 text-white px-2 py-1 rounded text-xs hover:bg-purple-600">
                                    üìÑ PDF
                                </button>
                                <button onclick="deleteEvent(${event.id}, '${event.title}')" class="bg-red-500 text-white px-2 py-1 rounded text-xs hover:bg-red-600">
                                    üóëÔ∏è Del
                                </button>
                            </div>
                        </td>
                    `;
                    eventsList.appendChild(row);
                });
            } else {
                eventsList.innerHTML = '<tr><td colspan="6" class="text-center py-8 text-gray-500">Nenhum evento criado ainda</td></tr>';
            }
        }

        // Change Event Password (Master Admin)
        async function changeEventPassword(eventId, eventTitle) {
            const newPassword = prompt(`Digite a nova senha para o evento "${eventTitle}":`);
            
            if (!newPassword) return;
            
            if (newPassword.length < 4) {
                alert('A senha deve ter pelo menos 4 caracteres!');
                return;
            }

            try {
                const { error } = await supabase
                    .from('events')
                    .update({ password: newPassword })
                    .eq('id', eventId);

                if (error) throw error;

                alert(`‚úÖ Senha do evento "${eventTitle}" alterada para: ${newPassword}`);
                loadMasterDashboard(); // Reload to show new password

            } catch (error) {
                console.error('Error changing event password:', error);
                alert('Erro ao alterar senha do evento.');
            }
        }

        // Copy Event URL (Master Admin)
        function copyEventUrlMaster(customUrl) {
            const url = `https://araujo418.github.io/painel-invitesqr/index.html?cliente=${customUrl}`;
            navigator.clipboard.writeText(url).then(() => {
                alert('Link do evento copiado!');
            });
        }

        // Download Event Report as PDF (Master Admin)
        async function downloadEventReport(eventId, eventTitle) {
            try {
                // Get event details
                const { data: event } = await supabase
                    .from('events')
                    .select('*')
                    .eq('id', eventId)
                    .single();

                // Get RSVPs for this event
                const { data: rsvps } = await supabase
                    .from('rsvps')
                    .select('*')
                    .eq('wedding_id', eventId)
                    .order('created_at', { ascending: false });

                if (!rsvps || rsvps.length === 0) {
                    alert('Nenhum convidado para exportar neste evento');
                    return;
                }

                // Separate confirmed and not confirmed
                const confirmed = rsvps.filter(r => r.attendance);
                const notConfirmed = rsvps.filter(r => !r.attendance);

                // Calculate statistics
                const totalGuests = rsvps.length;
                const confirmedGuests = confirmed.length;
                const totalPeople = rsvps.reduce((sum, r) => sum + (r.companion_name ? 2 : 1), 0);
                const confirmedPeople = confirmed.reduce((sum, r) => sum + (r.companion_name ? 2 : 1), 0);

                // Create PDF
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();

                // Set font to support special characters
                doc.setFont('helvetica');

                // Header
                doc.setFontSize(18);
                doc.setTextColor(40, 40, 40);
                doc.text('RELAT√ìRIO COMPLETO DO EVENTO', 105, 20, { align: 'center' });

                // Event info
                doc.setFontSize(14);
                doc.setTextColor(60, 60, 60);
                doc.text(eventTitle, 105, 35, { align: 'center' });
                doc.text(`Data do Evento: ${formatDate(event.event_date)}`, 105, 45, { align: 'center' });

                // Event details box
                doc.setFillColor(248, 250, 252);
                doc.rect(20, 55, 170, 45, 'F');
                doc.setDrawColor(148, 163, 184);
                doc.rect(20, 55, 170, 45);

                doc.setFontSize(12);
                doc.setTextColor(51, 65, 85);
                doc.text('DETALHES DO EVENTO', 105, 65, { align: 'center' });

                doc.setFontSize(10);
                doc.setTextColor(60, 60, 60);
                doc.text(`Usu√°rio: ${event.username}`, 25, 75);
                doc.text(`Senha: ${event.password}`, 25, 82);
                doc.text(`Limite M√°ximo: ${event.max_confirmations || 'Ilimitado'}`, 25, 89);
                doc.text(`Prazo Confirma√ß√£o: ${event.confirmation_deadline ? formatDate(event.confirmation_deadline) : 'Sem prazo'}`, 25, 96);

                // Statistics box
                doc.setFillColor(240, 248, 255);
                doc.rect(20, 110, 170, 35, 'F');
                doc.setDrawColor(59, 130, 246);
                doc.rect(20, 110, 170, 35);

                doc.setFontSize(12);
                doc.setTextColor(30, 64, 175);
                doc.text('ESTAT√çSTICAS', 105, 120, { align: 'center' });

                doc.setFontSize(10);
                doc.setTextColor(60, 60, 60);
                doc.text(`Total de Convidados: ${totalGuests}`, 25, 130);
                doc.text(`Confirmados: ${confirmedGuests}`, 25, 137);
                doc.text(`Total de Pessoas: ${totalPeople}`, 110, 130);
                doc.text(`Pessoas Confirmadas: ${confirmedPeople}`, 110, 137);

                let yPosition = 160;

                // Function to add guest section
                function addGuestSection(guests, title, color) {
                    if (guests.length === 0) return yPosition;

                    // Check if we need a new page
                    if (yPosition > 250) {
                        doc.addPage();
                        yPosition = 20;
                    }

                    // Section header
                    doc.setFillColor(color.bg.r, color.bg.g, color.bg.b);
                    doc.rect(20, yPosition - 5, 170, 12, 'F');
                    doc.setDrawColor(color.border.r, color.border.g, color.border.b);
                    doc.rect(20, yPosition - 5, 170, 12);

                    doc.setFontSize(12);
                    doc.setTextColor(color.text.r, color.text.g, color.text.b);
                    doc.text(`${title} (${guests.length})`, 25, yPosition + 2);

                    yPosition += 20;

                    // Guest list
                    doc.setFontSize(10);
                    doc.setTextColor(60, 60, 60);

                    guests.forEach(rsvp => {
                        // Check if we need a new page
                        if (yPosition > 270) {
                            doc.addPage();
                            yPosition = 20;
                        }

                        // Main guest
                        doc.setFont('helvetica', 'bold');
                        doc.text(`‚Ä¢ ${rsvp.guest_name}`, 25, yPosition);
                        doc.setFont('helvetica', 'normal');
                        doc.text(formatDate(rsvp.created_at), 150, yPosition);
                        yPosition += 7;

                        // Companion (if exists)
                        if (rsvp.companion_name) {
                            doc.setFont('helvetica', 'italic');
                            doc.setTextColor(100, 100, 100);
                            doc.text(`    ‚îî ${rsvp.companion_name} (Acompanhante)`, 25, yPosition);
                            doc.setFont('helvetica', 'normal');
                            doc.setTextColor(60, 60, 60);
                            yPosition += 7;
                        }

                        yPosition += 3; // Extra spacing between entries
                    });

                    yPosition += 10; // Extra spacing between sections
                    return yPosition;
                }

                // Add confirmed guests
                yPosition = addGuestSection(confirmed, '‚úì CONFIRMADOS', {
                    bg: { r: 240, g: 253, b: 244 },
                    border: { r: 34, g: 197, b: 94 },
                    text: { r: 21, g: 128, b: 61 }
                });

                // Add not confirmed guests
                yPosition = addGuestSection(notConfirmed, '‚úó N√ÉO CONFIRMADOS', {
                    bg: { r: 254, g: 242, b: 242 },
                    border: { r: 239, g: 68, b: 68 },
                    text: { r: 185, g: 28, b: 28 }
                });

                // Add messages section if any exist
                const { data: messages } = await supabase
                    .from('rsvps')
                    .select('*')
                    .eq('wedding_id', eventId)
                    .not('message', 'is', null)
                    .neq('message', '')
                    .order('created_at', { ascending: false });

                if (messages && messages.length > 0) {
                    // Check if we need a new page
                    if (yPosition > 200) {
                        doc.addPage();
                        yPosition = 20;
                    }

                    // Messages header
                    doc.setFillColor(252, 245, 255);
                    doc.rect(20, yPosition - 5, 170, 12, 'F');
                    doc.setDrawColor(168, 85, 247);
                    doc.rect(20, yPosition - 5, 170, 12);

                    doc.setFontSize(12);
                    doc.setTextColor(107, 33, 168);
                    doc.text(`üíå MENSAGENS DOS CONVIDADOS (${messages.length})`, 25, yPosition + 2);

                    yPosition += 20;

                    doc.setFontSize(9);
                    doc.setTextColor(60, 60, 60);

                    messages.forEach(msg => {
                        // Check if we need a new page
                        if (yPosition > 260) {
                            doc.addPage();
                            yPosition = 20;
                        }

                        // Message header
                        doc.setFont('helvetica', 'bold');
                        doc.text(`${msg.guest_name}`, 25, yPosition);
                        doc.setFont('helvetica', 'normal');
                        doc.text(formatDate(msg.created_at), 150, yPosition);
                        yPosition += 7;

                        // Message content (wrap text if too long)
                        const messageLines = doc.splitTextToSize(msg.message, 160);
                        doc.setTextColor(80, 80, 80);
                        messageLines.forEach(line => {
                            if (yPosition > 270) {
                                doc.addPage();
                                yPosition = 20;
                            }
                            doc.text(line, 25, yPosition);
                            yPosition += 5;
                        });

                        doc.setTextColor(60, 60, 60);
                        yPosition += 8; // Extra spacing between messages
                    });
                }

                // Footer
                const pageCount = doc.internal.getNumberOfPages();
                for (let i = 1; i <= pageCount; i++) {
                    doc.setPage(i);
                    doc.setFontSize(8);
                    doc.setTextColor(150, 150, 150);
                    doc.text(`P√°gina ${i} de ${pageCount}`, 105, 290, { align: 'center' });
                    doc.text(`Relat√≥rio Master Admin - Gerado em ${new Date().toLocaleDateString('pt-BR')} √†s ${new Date().toLocaleTimeString('pt-BR')}`, 105, 295, { align: 'center' });
                }

                // Save the PDF
                const fileName = `relatorio-completo-${eventTitle.replace(/[^a-z0-9]/gi, '-')}-${new Date().toISOString().split('T')[0]}.pdf`;
                doc.save(fileName);

                alert('üìÑ Relat√≥rio PDF completo gerado com sucesso!');

            } catch (error) {
                console.error('Error generating PDF report:', error);
                alert('Erro ao gerar relat√≥rio PDF. Tente novamente.');
            }
        }

        // Delete Event (Master Admin)
        async function deleteEvent(eventId, eventTitle) {
            const confirmDelete = confirm(`‚ö†Ô∏è ATEN√á√ÉO!\n\nTem certeza que deseja EXCLUIR PERMANENTEMENTE o evento "${eventTitle}"?\n\nEsta a√ß√£o ir√°:\n‚Ä¢ Excluir o evento\n‚Ä¢ Excluir TODOS os convidados\n‚Ä¢ Excluir TODAS as mensagens\n‚Ä¢ Tornar o link do evento inacess√≠vel\n\nEsta a√ß√£o N√ÉO PODE SER DESFEITA!`);
            
            if (!confirmDelete) return;

            const doubleConfirm = confirm(`üö® CONFIRMA√á√ÉO FINAL\n\nDigite "EXCLUIR" para confirmar a exclus√£o permanente do evento "${eventTitle}"`);
            
            if (!doubleConfirm) return;

            try {
                // Delete RSVPs first (includes messages since they're in the same table)
                await supabase.from('rsvps').delete().eq('wedding_id', eventId);
                
                const { error } = await supabase
                    .from('events')
                    .delete()
                    .eq('id', eventId);

                if (error) throw error;

                alert(`‚úÖ Evento "${eventTitle}" foi exclu√≠do permanentemente!`);
                loadMasterDashboard(); // Reload dashboard

            } catch (error) {
                console.error('Error deleting event:', error);
                alert('Erro ao excluir evento. Tente novamente.');
            }
        }

        // Delete Guest (Master Admin)
        async function deleteGuest(rsvpId, guestName, eventTitle) {
            const confirmDelete = confirm(`Tem certeza que deseja excluir o convidado "${guestName}" do evento "${eventTitle}"?`);
            
            if (!confirmDelete) return;

            try {
                const { error } = await supabase
                    .from('rsvps')
                    .delete()
                    .eq('id', rsvpId);

                if (error) throw error;

                alert(`‚úÖ Convidado "${guestName}" foi exclu√≠do!`);
                
                // Check if we're in event details view
                const detailsSection = document.getElementById('event-details-section');
                if (!detailsSection.classList.contains('hidden')) {
                    // Reload event details
                    const eventId = detailsSection.dataset.eventId;
                    if (eventId) {
                        showEventDetails(parseInt(eventId));
                    }
                } else {
                    // Reload master dashboard
                    loadMasterDashboard();
                }

            } catch (error) {
                console.error('Error deleting guest:', error);
                alert('Erro ao excluir convidado. Tente novamente.');
            }
        }

        // Show Event Details (Master Admin)
        async function showEventDetails(eventId) {
            try {
                // Get event details
                const { data: event } = await supabase
                    .from('events')
                    .select('*')
                    .eq('id', eventId)
                    .single();

                // Get RSVPs for this event
                const { data: rsvps } = await supabase
                    .from('rsvps')
                    .select('*')
                    .eq('wedding_id', eventId)
                    .order('created_at', { ascending: false });

                // Get messages for this event (from rsvps table)
                const { data: messages } = await supabase
                    .from('rsvps')
                    .select('*')
                    .eq('wedding_id', eventId)
                    .not('message', 'is', null)
                    .neq('message', '')
                    .order('created_at', { ascending: false });

                const detailsContent = document.getElementById('event-details-content');
                const detailsSection = document.getElementById('event-details-section');
                
                // Store event ID for future reference
                detailsSection.dataset.eventId = eventId;

                // Calculate statistics
                const totalGuests = rsvps ? rsvps.length : 0;
                const confirmedGuests = rsvps ? rsvps.filter(r => r.attendance).length : 0;
                const totalPeople = rsvps ? rsvps.reduce((sum, r) => sum + (r.companion_name ? 2 : 1), 0) : 0;
                const confirmedPeople = rsvps ? rsvps.filter(r => r.attendance).reduce((sum, r) => sum + (r.companion_name ? 2 : 1), 0) : 0;

                detailsContent.innerHTML = `
                    <!-- Event Info -->
                    <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-2xl p-6 mb-8 border border-blue-100">
                        <h4 class="text-2xl font-playfair font-semibold mb-4 text-gray-800">${event.title}</h4>
                        <div class="grid md:grid-cols-2 gap-4 text-sm">
                            <div><strong>Data do Evento:</strong> ${formatDate(event.event_date)}</div>
                            <div><strong>Usu√°rio:</strong> ${event.username}</div>
                            <div><strong>Senha:</strong> ${event.password}</div>
                            <div><strong>Criado em:</strong> ${formatDate(event.created_at)}</div>
                            <div><strong>Limite M√°ximo:</strong> ${event.max_confirmations || 'Ilimitado'}</div>
                            <div><strong>Prazo Confirma√ß√£o:</strong> ${event.confirmation_deadline ? formatDate(event.confirmation_deadline) : 'Sem prazo'}</div>
                        </div>
                        ${event.description ? `<div class="mt-4"><strong>Descri√ß√£o:</strong> ${event.description}</div>` : ''}
                        
                        <div class="flex gap-2 mt-4">
                            <button onclick="copyEventUrlMaster('${event.custom_url}')" class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600">
                                üìã Copiar Link
                            </button>
                            <button onclick="downloadEventReport(${event.id}, '${event.title}')" class="bg-purple-500 text-white px-4 py-2 rounded-lg hover:bg-purple-600">
                                üìä Baixar Relat√≥rio
                            </button>
                        </div>
                    </div>

                    <!-- Statistics -->
                    <div class="grid md:grid-cols-4 gap-4 mb-8">
                        <div class="bg-blue-50 rounded-xl p-4 text-center border border-blue-100">
                            <div class="text-2xl font-bold text-blue-600">${totalGuests}</div>
                            <div class="text-sm text-blue-700">Total Convidados</div>
                        </div>
                        <div class="bg-green-50 rounded-xl p-4 text-center border border-green-100">
                            <div class="text-2xl font-bold text-green-600">${confirmedGuests}</div>
                            <div class="text-sm text-green-700">Confirmados</div>
                        </div>
                        <div class="bg-purple-50 rounded-xl p-4 text-center border border-purple-100">
                            <div class="text-2xl font-bold text-purple-600">${totalPeople}</div>
                            <div class="text-sm text-purple-700">Total Pessoas</div>
                        </div>
                        <div class="bg-orange-50 rounded-xl p-4 text-center border border-orange-100">
                            <div class="text-2xl font-bold text-orange-600">${confirmedPeople}</div>
                            <div class="text-sm text-orange-700">Pessoas Confirmadas</div>
                        </div>
                    </div>

                    <!-- Guest List -->
                    <div class="mb-8">
                        <h5 class="text-xl font-semibold mb-4 text-gray-800">üë• Lista de Convidados</h5>
                        <div class="overflow-x-auto">
                            <table class="w-full bg-white rounded-lg border">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="text-left py-3 px-4 border-b">Nome</th>
                                        <th class="text-left py-3 px-4 border-b">Acompanhante</th>
                                        <th class="text-left py-3 px-4 border-b">Status</th>
                                        <th class="text-left py-3 px-4 border-b">Total Pessoas</th>
                                        <th class="text-left py-3 px-4 border-b">Data</th>
                                        <th class="text-left py-3 px-4 border-b">A√ß√µes</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${rsvps && rsvps.length > 0 ? rsvps.map(rsvp => `
                                        <tr class="hover:bg-gray-50">
                                            <td class="py-3 px-4 border-b">${rsvp.guest_name}</td>
                                            <td class="py-3 px-4 border-b">${rsvp.companion_name || '-'}</td>
                                            <td class="py-3 px-4 border-b">
                                                <span class="px-2 py-1 rounded-full text-xs ${rsvp.attendance ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                                    ${rsvp.attendance ? '‚úÖ Confirmado' : '‚ùå N√£o Confirmado'}
                                                </span>
                                            </td>
                                            <td class="py-3 px-4 border-b">${rsvp.companion_name ? 2 : 1}</td>
                                            <td class="py-3 px-4 border-b">${formatDate(rsvp.created_at)}</td>
                                            <td class="py-3 px-4 border-b">
                                                <button onclick="deleteGuest(${rsvp.id}, '${rsvp.guest_name}', '${event.title}')" class="bg-red-500 text-white px-2 py-1 rounded text-xs hover:bg-red-600">
                                                    üóëÔ∏è Excluir
                                                </button>
                                            </td>
                                        </tr>
                                    `).join('') : '<tr><td colspan="6" class="text-center py-8 text-gray-500">Nenhum convidado ainda</td></tr>'}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Messages -->
                    <div>
                        <h5 class="text-xl font-semibold mb-4 text-gray-800">üíå Mensagens dos Convidados</h5>
                        <div class="space-y-4 max-h-96 overflow-y-auto">
                            ${messages && messages.length > 0 ? messages.map(msg => `
                                <div class="bg-gray-50 rounded-xl p-4 border">
                                    <div class="flex justify-between items-start mb-2">
                                        <h6 class="font-semibold text-gray-800">${msg.guest_name}</h6>
                                        <div class="flex gap-2 items-center">
                                            <span class="text-sm text-gray-500">${formatDate(msg.created_at)}</span>
                                            <button onclick="deleteMessage(${msg.id}, '${msg.guest_name}')" class="bg-red-500 text-white px-2 py-1 rounded text-xs hover:bg-red-600">
                                                üóëÔ∏è
                                            </button>
                                        </div>
                                    </div>
                                    <p class="text-gray-600">${msg.message}</p>
                                </div>
                            `).join('') : '<p class="text-center text-gray-500 py-8">Nenhuma mensagem ainda</p>'}
                        </div>
                    </div>
                `;

                // Show details section
                detailsSection.classList.remove('hidden');

            } catch (error) {
                console.error('Error loading event details:', error);
                alert('Erro ao carregar detalhes do evento.');
            }
        }

        // Hide Event Details
        function hideEventDetails() {
            document.getElementById('event-details-section').classList.add('hidden');
        }

        // Delete Message (Master Admin)
        async function deleteMessage(messageId, guestName) {
            const confirmDelete = confirm(`Tem certeza que deseja excluir a mensagem de "${guestName}"?`);
            
            if (!confirmDelete) return;

            try {
                // Clear the message field instead of deleting the entire record
                const { error } = await supabase
                    .from('rsvps')
                    .update({ message: null })
                    .eq('id', messageId);

                if (error) throw error;

                alert(`‚úÖ Mensagem de "${guestName}" foi exclu√≠da!`);
                
                // Reload event details
                const detailsSection = document.getElementById('event-details-section');
                const eventId = detailsSection.dataset.eventId;
                if (eventId) {
                    showEventDetails(parseInt(eventId));
                }

            } catch (error) {
                console.error('Error deleting message:', error);
                alert('Erro ao excluir mensagem. Tente novamente.');
            }
        }

        // Load Dashboard
        async function loadDashboard() {
            if (!currentEvent) return;

            // Update event info
            document.getElementById('event-info').textContent = 
                `${currentEvent.title} - ${formatDate(currentEvent.event_date)}`;

            // Show/hide stats based on event configuration
            if (currentEvent.enable_max_limit) {
                document.getElementById('max-limit-stat').style.display = 'block';
            } else {
                document.getElementById('max-limit-stat').style.display = 'none';
            }

            if (currentEvent.enable_deadline) {
                document.getElementById('deadline-stat').style.display = 'block';
            } else {
                document.getElementById('deadline-stat').style.display = 'none';
            }

            // Load statistics
            await loadStatistics();
            
            // Load guest list
            await loadGuestList();
            
            // Load messages
            await loadMessages();
        }

        // Load Statistics
        async function loadStatistics() {
            try {
                // Get RSVPs
                const { data: rsvps } = await supabase
                    .from('rsvps')
                    .select('*')
                    .eq('wedding_id', currentEvent.id);

                // Get Messages (from rsvps table where message is not null)
                const { data: messages } = await supabase
                    .from('rsvps')
                    .select('*')
                    .eq('wedding_id', currentEvent.id)
                    .not('message', 'is', null)
                    .neq('message', '');

                const totalGuests = rsvps ? rsvps.length : 0;
                const confirmedGuests = rsvps ? rsvps.filter(r => r.attendance).length : 0;
                const totalMessages = messages ? messages.length : 0;

                document.getElementById('total-guests').textContent = totalGuests;
                document.getElementById('confirmed-guests').textContent = confirmedGuests;
                
                if (currentEvent.enable_max_limit && document.getElementById('max-limit')) {
                    document.getElementById('max-limit').textContent = currentEvent.max_confirmations || 'Ilimitado';
                }
                
                if (currentEvent.enable_deadline && document.getElementById('deadline-info')) {
                    document.getElementById('deadline-info').textContent = formatDate(currentEvent.confirmation_deadline);
                }

            } catch (error) {
                console.error('Error loading statistics:', error);
            }
        }

        // Load Guest List
        async function loadGuestList() {
            try {
                const { data: rsvps } = await supabase
                    .from('rsvps')
                    .select('*')
                    .eq('wedding_id', currentEvent.id)
                    .order('created_at', { ascending: false });

                const guestList = document.getElementById('guest-list');
                guestList.innerHTML = '';

                if (rsvps && rsvps.length > 0) {
                    // Separate confirmed and not confirmed
                    const confirmed = rsvps.filter(r => r.attendance);
                    const notConfirmed = rsvps.filter(r => !r.attendance);

                    // Function to create guest rows
                    function createGuestRows(guests, isConfirmed) {
                        guests.forEach(rsvp => {
                            // Main guest row
                            const mainRow = document.createElement('tr');
                            mainRow.className = 'border-b hover:bg-gray-50';
                            mainRow.innerHTML = `
                                <td class="py-3 px-4 font-semibold">${rsvp.guest_name}</td>
                                <td class="py-3 px-4">-</td>
                                <td class="py-3 px-4">
                                    <span class="px-2 py-1 rounded-full text-xs ${isConfirmed ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                        ${isConfirmed ? '‚úÖ Confirmado' : '‚ùå N√£o Confirmado'}
                                    </span>
                                </td>
                                <td class="py-3 px-4">${formatDate(rsvp.created_at)}</td>
                            `;
                            guestList.appendChild(mainRow);

                            // Companion row (if exists)
                            if (rsvp.companion_name) {
                                const companionRow = document.createElement('tr');
                                companionRow.className = 'border-b hover:bg-gray-50 bg-gray-25';
                                companionRow.innerHTML = `
                                    <td class="py-2 px-4 pl-8 text-gray-600 italic">${rsvp.companion_name}</td>
                                    <td class="py-2 px-4 text-sm text-gray-500">Acompanhante</td>
                                    <td class="py-2 px-4">
                                        <span class="px-2 py-1 rounded-full text-xs ${isConfirmed ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                            ${isConfirmed ? '‚úÖ Confirmado' : '‚ùå N√£o Confirmado'}
                                        </span>
                                    </td>
                                    <td class="py-2 px-4 text-sm text-gray-500">${formatDate(rsvp.created_at)}</td>
                                `;
                                guestList.appendChild(companionRow);
                            }
                        });
                    }

                    // Add confirmed guests first
                    if (confirmed.length > 0) {
                        const sectionRow = document.createElement('tr');
                        sectionRow.innerHTML = `
                            <td colspan="4" class="py-3 px-4 bg-green-50 font-bold text-green-800 border-b-2 border-green-200">
                                ‚úÖ CONFIRMADOS (${confirmed.length})
                            </td>
                        `;
                        guestList.appendChild(sectionRow);
                        createGuestRows(confirmed, true);
                    }

                    // Add not confirmed guests
                    if (notConfirmed.length > 0) {
                        const sectionRow = document.createElement('tr');
                        sectionRow.innerHTML = `
                            <td colspan="4" class="py-3 px-4 bg-red-50 font-bold text-red-800 border-b-2 border-red-200">
                                ‚ùå N√ÉO CONFIRMADOS (${notConfirmed.length})
                            </td>
                        `;
                        guestList.appendChild(sectionRow);
                        createGuestRows(notConfirmed, false);
                    }
                } else {
                    guestList.innerHTML = '<tr><td colspan="4" class="text-center py-8 text-gray-500">Nenhum convidado ainda</td></tr>';
                }

            } catch (error) {
                console.error('Error loading guest list:', error);
            }
        }

        // Load Messages
        async function loadMessages() {
            try {
                const { data: messages } = await supabase
                    .from('rsvps')
                    .select('*')
                    .eq('wedding_id', currentEvent.id)
                    .not('message', 'is', null)
                    .neq('message', '')
                    .order('created_at', { ascending: false });

                const messagesList = document.getElementById('messages-list');
                messagesList.innerHTML = '';

                if (messages && messages.length > 0) {
                    messages.forEach(message => {
                        const messageDiv = document.createElement('div');
                        messageDiv.className = 'bg-gray-50 rounded-xl p-4';
                        messageDiv.innerHTML = `
                            <div class="flex justify-between items-start mb-2">
                                <h4 class="font-semibold text-gray-800">${message.guest_name}</h4>
                                <span class="text-sm text-gray-500">${formatDate(message.created_at)}</span>
                            </div>
                            <p class="text-gray-600">${message.message}</p>
                        `;
                        messagesList.appendChild(messageDiv);
                    });
                } else {
                    messagesList.innerHTML = '<p class="text-center text-gray-500 py-8">Nenhuma mensagem ainda</p>';
                }

            } catch (error) {
                console.error('Error loading messages:', error);
            }
        }

        // Copy Event URL
        function copyEventUrl() {
            const url = `https://araujo418.github.io/painel-invitesqr/index.html?cliente=${currentEvent.custom_url}`;
            navigator.clipboard.writeText(url).then(() => {
                alert('Link completo copiado! (permite acompanhantes)');
            });
        }

        // Copy Event URL without companion option
        function copyEventUrlNoCompanion() {
            const url = `https://araujo418.github.io/painel-invitesqr/index.html?cliente=${currentEvent.custom_url}&companion=no`;
            navigator.clipboard.writeText(url).then(() => {
                alert('Link sem acompanhante copiado! (n√£o permite acompanhantes)');
            });
        }

        // Download Guest Report as PDF
        async function downloadGuestReport() {
            try {
                const { data: rsvps } = await supabase
                    .from('rsvps')
                    .select('*')
                    .eq('wedding_id', currentEvent.id)
                    .order('created_at', { ascending: false });

                if (!rsvps || rsvps.length === 0) {
                    alert('Nenhum convidado para exportar');
                    return;
                }

                // Separate confirmed and not confirmed
                const confirmed = rsvps.filter(r => r.attendance);
                const notConfirmed = rsvps.filter(r => !r.attendance);

                // Calculate statistics
                const totalGuests = rsvps.length;
                const confirmedGuests = confirmed.length;
                const totalPeople = rsvps.reduce((sum, r) => sum + (r.companion_name ? 2 : 1), 0);
                const confirmedPeople = confirmed.reduce((sum, r) => sum + (r.companion_name ? 2 : 1), 0);

                // Create PDF
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();

                // Set font to support special characters
                doc.setFont('helvetica');

                // Header
                doc.setFontSize(20);
                doc.setTextColor(40, 40, 40);
                doc.text('RELAT√ìRIO DE CONVIDADOS', 105, 20, { align: 'center' });

                // Event info
                doc.setFontSize(14);
                doc.setTextColor(60, 60, 60);
                doc.text(currentEvent.title, 105, 35, { align: 'center' });
                doc.text(`Data do Evento: ${formatDate(currentEvent.event_date)}`, 105, 45, { align: 'center' });

                // Statistics box
                doc.setFillColor(240, 248, 255);
                doc.rect(20, 55, 170, 35, 'F');
                doc.setDrawColor(59, 130, 246);
                doc.rect(20, 55, 170, 35);

                doc.setFontSize(12);
                doc.setTextColor(30, 64, 175);
                doc.text('ESTAT√çSTICAS', 105, 65, { align: 'center' });

                doc.setFontSize(10);
                doc.setTextColor(60, 60, 60);
                doc.text(`Total de Convidados: ${totalGuests}`, 25, 75);
                doc.text(`Confirmados: ${confirmedGuests}`, 25, 82);
                doc.text(`Total de Pessoas: ${totalPeople}`, 110, 75);
                doc.text(`Pessoas Confirmadas: ${confirmedPeople}`, 110, 82);

                let yPosition = 105;

                // Function to add guest section
                function addGuestSection(guests, title, color) {
                    if (guests.length === 0) return yPosition;

                    // Check if we need a new page
                    if (yPosition > 250) {
                        doc.addPage();
                        yPosition = 20;
                    }

                    // Section header
                    doc.setFillColor(color.bg.r, color.bg.g, color.bg.b);
                    doc.rect(20, yPosition - 5, 170, 12, 'F');
                    doc.setDrawColor(color.border.r, color.border.g, color.border.b);
                    doc.rect(20, yPosition - 5, 170, 12);

                    doc.setFontSize(12);
                    doc.setTextColor(color.text.r, color.text.g, color.text.b);
                    doc.text(`${title} (${guests.length})`, 25, yPosition + 2);

                    yPosition += 20;

                    // Guest list
                    doc.setFontSize(10);
                    doc.setTextColor(60, 60, 60);

                    guests.forEach(rsvp => {
                        // Check if we need a new page
                        if (yPosition > 270) {
                            doc.addPage();
                            yPosition = 20;
                        }

                        // Main guest
                        doc.setFont('helvetica', 'bold');
                        doc.text(`‚Ä¢ ${rsvp.guest_name}`, 25, yPosition);
                        doc.setFont('helvetica', 'normal');
                        doc.text(formatDate(rsvp.created_at), 150, yPosition);
                        yPosition += 7;

                        // Companion (if exists)
                        if (rsvp.companion_name) {
                            doc.setFont('helvetica', 'italic');
                            doc.setTextColor(100, 100, 100);
                            doc.text(`    ‚îî ${rsvp.companion_name} (Acompanhante)`, 25, yPosition);
                            doc.setFont('helvetica', 'normal');
                            doc.setTextColor(60, 60, 60);
                            yPosition += 7;
                        }

                        yPosition += 3; // Extra spacing between entries
                    });

                    yPosition += 10; // Extra spacing between sections
                    return yPosition;
                }

                // Add confirmed guests
                yPosition = addGuestSection(confirmed, '‚úì CONFIRMADOS', {
                    bg: { r: 240, g: 253, b: 244 },
                    border: { r: 34, g: 197, b: 94 },
                    text: { r: 21, g: 128, b: 61 }
                });

                // Add not confirmed guests
                yPosition = addGuestSection(notConfirmed, '‚úó N√ÉO CONFIRMADOS', {
                    bg: { r: 254, g: 242, b: 242 },
                    border: { r: 239, g: 68, b: 68 },
                    text: { r: 185, g: 28, b: 28 }
                });

                // Add messages section if any exist
                const { data: messages } = await supabase
                    .from('rsvps')
                    .select('*')
                    .eq('wedding_id', currentEvent.id)
                    .not('message', 'is', null)
                    .neq('message', '')
                    .order('created_at', { ascending: false });

                if (messages && messages.length > 0) {
                    // Check if we need a new page
                    if (yPosition > 200) {
                        doc.addPage();
                        yPosition = 20;
                    }

                    // Messages header
                    doc.setFillColor(252, 245, 255);
                    doc.rect(20, yPosition - 5, 170, 12, 'F');
                    doc.setDrawColor(168, 85, 247);
                    doc.rect(20, yPosition - 5, 170, 12);

                    doc.setFontSize(12);
                    doc.setTextColor(107, 33, 168);
                    doc.text(`üíå MENSAGENS DOS CONVIDADOS (${messages.length})`, 25, yPosition + 2);

                    yPosition += 20;

                    doc.setFontSize(9);
                    doc.setTextColor(60, 60, 60);

                    messages.forEach(msg => {
                        // Check if we need a new page
                        if (yPosition > 260) {
                            doc.addPage();
                            yPosition = 20;
                        }

                        // Message header
                        doc.setFont('helvetica', 'bold');
                        doc.text(`${msg.guest_name}`, 25, yPosition);
                        doc.setFont('helvetica', 'normal');
                        doc.text(formatDate(msg.created_at), 150, yPosition);
                        yPosition += 7;

                        // Message content (wrap text if too long)
                        const messageLines = doc.splitTextToSize(msg.message, 160);
                        doc.setTextColor(80, 80, 80);
                        messageLines.forEach(line => {
                            if (yPosition > 270) {
                                doc.addPage();
                                yPosition = 20;
                            }
                            doc.text(line, 25, yPosition);
                            yPosition += 5;
                        });

                        doc.setTextColor(60, 60, 60);
                        yPosition += 8; // Extra spacing between messages
                    });
                }

                // Footer
                const pageCount = doc.internal.getNumberOfPages();
                for (let i = 1; i <= pageCount; i++) {
                    doc.setPage(i);
                    doc.setFontSize(8);
                    doc.setTextColor(150, 150, 150);
                    doc.text(`P√°gina ${i} de ${pageCount}`, 105, 290, { align: 'center' });
                    doc.text(`Gerado em ${new Date().toLocaleDateString('pt-BR')} √†s ${new Date().toLocaleTimeString('pt-BR')}`, 105, 295, { align: 'center' });
                }

                // Save the PDF
                const fileName = `relatorio-${currentEvent.title.replace(/[^a-z0-9]/gi, '-')}-${new Date().toISOString().split('T')[0]}.pdf`;
                doc.save(fileName);

                alert('üìÑ Relat√≥rio PDF gerado com sucesso!');

            } catch (error) {
                console.error('Error generating PDF report:', error);
                alert('Erro ao gerar relat√≥rio PDF. Tente novamente.');
            }
        }

        // Logout
        function logout() {
            currentUser = null;
            currentEvent = null;
            isMasterAdmin = false;
            clearSession();
            
            // Clear countdown
            if (countdownInterval) {
                clearInterval(countdownInterval);
                countdownInterval = null;
            }
            
            // Reset forms
            document.getElementById('adminLoginForm').reset();
            document.getElementById('masterAdminForm').reset();
            
            // Hide password section if visible
            hidePasswordSection();
            
            showSection('home');
        }

        // Countdown Timer Function
        function startCountdown(eventDate) {
            if (countdownInterval) {
                clearInterval(countdownInterval);
            }

            const targetDate = new Date(eventDate).getTime();

            countdownInterval = setInterval(() => {
                const now = new Date().getTime();
                const distance = targetDate - now;

                if (distance < 0) {
                    clearInterval(countdownInterval);
                    document.getElementById('countdown-message').innerHTML = 'üéâ <strong>O evento chegou!</strong>';
                    document.getElementById('countdown-timer').innerHTML = '<div class="text-center text-4xl">üéâ</div>';
                    return;
                }

                const days = Math.floor(distance / (1000 * 60 * 60 * 24));
                const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((distance % (1000 * 60)) / 1000);

                document.getElementById('days').textContent = days.toString().padStart(2, '0');
                document.getElementById('hours').textContent = hours.toString().padStart(2, '0');
                document.getElementById('minutes').textContent = minutes.toString().padStart(2, '0');
                document.getElementById('seconds').textContent = seconds.toString().padStart(2, '0');

                // Update message based on time remaining
                let message = '';
                if (days > 30) {
                    message = 'üóìÔ∏è Ainda temos tempo para nos preparar!';
                } else if (days > 7) {
                    message = 'üìÖ O evento est√° se aproximando!';
                } else if (days > 1) {
                    message = '‚è∞ √öltimos dias para se preparar!';
                } else if (days === 1) {
                    message = 'üö® <strong>Amanh√£ √© o grande dia!</strong>';
                } else if (hours > 1) {
                    message = 'üî• <strong>Hoje √© o dia! Faltam poucas horas!</strong>';
                } else {
                    message = '‚ö° <strong>O evento est√° come√ßando!</strong>';
                }

                document.getElementById('countdown-message').innerHTML = message;

                // Add pulse animation when less than 24 hours
                if (days === 0) {
                    document.getElementById('countdown-timer').classList.add('countdown-pulse');
                }

            }, 1000);
        }

        // Utility Functions
        function formatDate(dateString) {
            return new Date(dateString).toLocaleDateString('pt-BR');
        }

        // Check for event site parameter on load
        window.addEventListener('DOMContentLoaded', () => {
            if (clienteParam) {
                // Load event site for guests
                loadEventSite(clienteParam);
            } else {
                // Setup field toggles for create form
                setupFieldToggles();
                

                
                // Check for existing session
                const session = loadSession();
                if (session) {
                    currentUser = session;
                    currentEvent = session;
                    loadDashboard();
                    showSection('dashboard');
                } else {
                    showSection('home');
                }
            }
        });

        // Test Database Connection
        async function testDatabaseConnection() {
            try {
                console.log('Testing database connection...');
                const { data, error } = await supabase
                    .from('events')
                    .select('count')
                    .limit(1);

                if (error) {
                    console.error('Database connection test failed:', error);
                    return false;
                }
                
                console.log('Database connection successful');
                return true;
            } catch (error) {
                console.error('Database connection error:', error);
                return false;
            }
        }

        // Load Event Site for Guests
        async function loadEventSite(customUrl) {
            try {
                // Setup guest header
                setupGuestHeader();

                // Test connection first
                const connectionOk = await testDatabaseConnection();
                if (!connectionOk) {
                    alert('Erro de conex√£o com o banco de dados. Verifique sua internet.');
                    return;
                }

                const { data: event, error } = await supabase
                    .from('events')
                    .select('*')
                    .eq('custom_url', customUrl)
                    .single();

                if (error) {
                    console.error('Error loading event:', error);
                    if (error.code === 'PGRST116') {
                        alert('Evento n√£o encontrado. Verifique o link.');
                    } else {
                        alert(`Erro ao carregar evento: ${error.message}`);
                    }
                    return;
                }

                if (!event) {
                    alert('Evento n√£o encontrado');
                    return;
                }

                currentEvent = event;
                renderEventSite();
                showSection('event-site');

            } catch (error) {
                console.error('Error loading event site:', error);
                alert('Erro ao carregar evento. Verifique sua conex√£o.');
            }
        }

        // Setup Guest Header
        function setupGuestHeader() {
            const header = document.getElementById('main-header');
            header.classList.add('guest-header');
            
            // Update header content for guest view
            const headerContent = header.querySelector('div');
            headerContent.innerHTML = `
                <h1 class="text-xl font-semibold text-gray-900">Invites</h1>
                <button onclick="showSection('login')" class="btn-secondary text-sm">
                    üë§ Login
                </button>
            `;

            // Hide master admin access for guests
            document.getElementById('master-admin-access').style.display = 'none';
        }

        // Go back from login (for guest pages)
        function goBackFromLogin() {
            const urlParams = new URLSearchParams(window.location.search);
            const clienteParam = urlParams.get('cliente');
            
            if (clienteParam) {
                // If on guest page, go back to event site
                showSection('event-site');
            } else {
                // If on main site, go back to home
                showSection('home');
            }
        }

        // Render Event Site for Guests
        function renderEventSite() {
            const content = document.getElementById('event-site-content');
            const today = new Date();
            today.setHours(0, 0, 0, 0); // Reset time to start of day for accurate comparison
            const hasDeadline = currentEvent.enable_deadline && currentEvent.confirmation_deadline;
            const deadline = hasDeadline ? new Date(currentEvent.confirmation_deadline) : null;
            if (deadline) deadline.setHours(23, 59, 59, 999); // Set to end of deadline day
            const isDeadlinePassed = hasDeadline && today > deadline;
            
            // Check if companions are allowed based on URL parameter
            const urlParams = new URLSearchParams(window.location.search);
            const allowCompanion = urlParams.get('companion') !== 'no';
            
            content.innerHTML = `
                <div class="max-w-4xl mx-auto px-4 guest-content">
                    <div class="premium-card rounded-2xl sm:rounded-3xl p-6 sm:p-8 lg:p-12 text-center">
                        <h1 class="font-playfair text-3xl sm:text-5xl lg:text-7xl text-gray-800 mb-4 sm:mb-6 font-bold tracking-tight">${currentEvent.title}</h1>
                        <div class="w-16 sm:w-24 h-1 bg-gradient-to-r from-purple-400 to-blue-400 mx-auto mb-6 sm:mb-8 rounded-full"></div>
                        ${currentEvent.enable_description && currentEvent.description ? `<p class="text-lg sm:text-xl lg:text-2xl text-gray-600 mb-6 sm:mb-8 leading-relaxed">${currentEvent.description}</p>` : ''}
                        <p class="text-xl sm:text-2xl text-gray-600 mb-6 sm:mb-8">üìÖ ${formatDate(currentEvent.event_date)}</p>
                        
                        <!-- Countdown Timer -->
                        <div class="bg-gradient-to-br from-indigo-50 to-purple-50 rounded-2xl sm:rounded-3xl p-4 sm:p-6 lg:p-8 mb-6 sm:mb-8 border border-indigo-100">
                            <h3 class="text-xl sm:text-2xl font-playfair font-semibold mb-4 sm:mb-6 text-gray-800">‚è∞ Contagem Regressiva</h3>
                            <div id="countdown-timer" class="grid grid-cols-4 gap-2 sm:gap-4 max-w-lg mx-auto">
                                <div class="text-center">
                                    <div class="bg-white rounded-lg sm:rounded-xl p-2 sm:p-4 shadow-sm border">
                                        <div id="days" class="text-xl sm:text-2xl lg:text-3xl font-bold text-indigo-600">00</div>
                                        <div class="text-xs sm:text-sm text-gray-600 font-medium">Dias</div>
                                    </div>
                                </div>
                                <div class="text-center">
                                    <div class="bg-white rounded-lg sm:rounded-xl p-2 sm:p-4 shadow-sm border">
                                        <div id="hours" class="text-xl sm:text-2xl lg:text-3xl font-bold text-purple-600">00</div>
                                        <div class="text-xs sm:text-sm text-gray-600 font-medium">Horas</div>
                                    </div>
                                </div>
                                <div class="text-center">
                                    <div class="bg-white rounded-lg sm:rounded-xl p-2 sm:p-4 shadow-sm border">
                                        <div id="minutes" class="text-xl sm:text-2xl lg:text-3xl font-bold text-pink-600">00</div>
                                        <div class="text-xs sm:text-sm text-gray-600 font-medium">Minutos</div>
                                    </div>
                                </div>
                                <div class="text-center">
                                    <div class="bg-white rounded-lg sm:rounded-xl p-2 sm:p-4 shadow-sm border">
                                        <div id="seconds" class="text-xl sm:text-2xl lg:text-3xl font-bold text-red-600">00</div>
                                        <div class="text-xs sm:text-sm text-gray-600 font-medium">Segundos</div>
                                    </div>
                                </div>
                            </div>
                            <div id="countdown-message" class="text-center mt-4 sm:mt-6 text-base sm:text-lg font-medium text-gray-700"></div>
                        </div>
                        
                        ${isDeadlinePassed ? `
                            <div class="bg-gradient-to-r from-red-50 to-rose-50 rounded-3xl p-8 mb-8 border border-red-200">
                                <h3 class="text-3xl font-playfair font-semibold mb-4 text-red-800">‚è∞ Prazo Encerrado</h3>
                                <p class="text-xl text-red-700">O prazo para confirma√ß√£o de presen√ßa foi at√© ${formatDate(currentEvent.confirmation_deadline)}</p>
                            </div>
                        ` : `
                            <!-- Response Status or RSVP Form -->
                            <div id="rsvp-container">
                                <!-- This will be populated by JavaScript -->
                            </div>
                        `}

                        <div id="message-container" class="bg-gradient-to-br from-purple-50 to-pink-50 rounded-2xl sm:rounded-3xl p-4 sm:p-6 lg:p-8 mb-6 sm:mb-8 border border-purple-100">
                            <!-- This will be populated by JavaScript -->
                        </div>

                        <div class="bg-gradient-to-br from-slate-50 to-gray-50 rounded-2xl sm:rounded-3xl p-4 sm:p-6 lg:p-8 border border-slate-200">
                            <h3 class="text-2xl sm:text-3xl font-playfair font-semibold mb-4 sm:mb-6 text-gray-800">üí¨ Mural de Mensagens</h3>
                            <div id="public-messages-list" class="space-y-4 sm:space-y-6 max-h-80 sm:max-h-96 overflow-y-auto">
                                <!-- Public messages will be loaded here -->
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Start countdown timer
            startCountdown(currentEvent.event_date);

            // Render RSVP section
            renderRSVPSection(isDeadlinePassed, allowCompanion);
            
            // Render message section
            renderMessageSection();
            
            // Load public messages
            loadPublicMessages();
        }

        // Render RSVP Section
        async function renderRSVPSection(isDeadlinePassed, allowCompanion) {
            const container = document.getElementById('rsvp-container');
            
            if (userResponse) {
                // Show response status
                const statusMessage = userResponse.attendance ? 
                    `‚úÖ Voc√™ confirmou presen√ßa${userResponse.companion_name ? ` junto com ${userResponse.companion_name}` : ''}!` :
                    '‚ùå Voc√™ informou que n√£o poder√° comparecer.';
                
                container.innerHTML = `
                    <div class="response-status">
                        <h3 class="text-2xl font-playfair font-semibold mb-2">A sua resposta foi enviada, grato! üôè</h3>
                        <p class="text-lg mb-4">${statusMessage}</p>
                        <button onclick="editResponse()" class="edit-response-btn">
                            ‚úèÔ∏è Editar resposta
                        </button>
                    </div>
                `;
            } else {
                // Show RSVP form
                const hasDeadline = currentEvent.enable_deadline && currentEvent.confirmation_deadline;
                
                container.innerHTML = `
                    <div class="bg-gradient-to-br from-blue-50 to-indigo-50 rounded-2xl sm:rounded-3xl p-4 sm:p-6 lg:p-8 mb-6 sm:mb-8 border border-blue-100">
                        <h3 class="text-2xl sm:text-3xl font-playfair font-semibold mb-4 sm:mb-6 text-gray-800">Confirma Presen√ßa?</h3>
                        ${hasDeadline ? `<p class="text-base sm:text-lg text-gray-600 mb-6 sm:mb-8">‚è∞ Prazo at√©: ${formatDate(currentEvent.confirmation_deadline)}</p>` : ''}
                        
                        <form id="rsvp-form" class="space-y-4 sm:space-y-6">
                            <!-- Confirma√ß√£o SIM/N√ÉO -->
                            <div class="flex justify-center gap-8 sm:gap-12 mb-6 sm:mb-8">
                                <label class="flex items-center gap-2 sm:gap-3 cursor-pointer">
                                    <input type="radio" name="attendance" value="yes" id="attendance-yes" class="w-5 h-5 sm:w-6 sm:h-6 text-green-500">
                                    <span class="text-xl sm:text-2xl font-semibold text-gray-800">SIM</span>
                                </label>
                                <label class="flex items-center gap-2 sm:gap-3 cursor-pointer">
                                    <input type="radio" name="attendance" value="no" id="attendance-no" class="w-5 h-5 sm:w-6 sm:h-6 text-red-500">
                                    <span class="text-xl sm:text-2xl font-semibold text-gray-800">N√ÉO</span>
                                </label>
                            </div>
                            
                            <!-- Campos que aparecem quando marca SIM -->
                            <div id="yes-fields" class="hidden space-y-4 sm:space-y-6">
                                <div>
                                    <input type="text" id="guest-name" placeholder="Seu nome completo" required class="w-full px-4 sm:px-6 py-3 sm:py-4 premium-input rounded-xl focus:outline-none text-base sm:text-lg">
                                </div>
                                
                                ${allowCompanion ? `
                                <div class="flex items-center gap-3 sm:gap-4 justify-center">
                                    <input type="checkbox" id="has-companion" class="w-5 h-5 sm:w-6 sm:h-6 text-blue-500 rounded focus:ring-blue-500">
                                    <label for="has-companion" class="text-gray-700 text-base sm:text-lg">Adicionar acompanhante</label>
                                </div>
                                
                                <div id="companion-field" class="hidden">
                                    <input type="text" id="companion-name" placeholder="Nome do acompanhante" class="w-full px-4 sm:px-6 py-3 sm:py-4 premium-input rounded-xl focus:outline-none text-base sm:text-lg">
                                </div>
                                ` : ''}
                            </div>
                            
                            <!-- Campos que aparecem quando marca N√ÉO -->
                            <div id="no-fields" class="hidden space-y-4 sm:space-y-6">
                                <div>
                                    <input type="text" id="guest-name-no" placeholder="Seu nome completo" required class="w-full px-4 sm:px-6 py-3 sm:py-4 premium-input rounded-xl focus:outline-none text-base sm:text-lg">
                                </div>
                            </div>
                            
                            <div class="flex justify-center">
                                <button type="submit" id="submit-rsvp" class="bg-gradient-to-r from-purple-500 to-blue-500 hover:shadow-xl text-white px-8 sm:px-12 py-3 sm:py-4 rounded-xl font-semibold text-base sm:text-lg transition-all duration-300 disabled:opacity-50" disabled>
                                    üìù Confirmar Resposta
                                </button>
                            </div>
                        </form>
                    </div>
                `;

                // Add event listeners for RSVP form
                setupRSVPEventListeners(allowCompanion);
            }
        }

        // Setup RSVP Event Listeners
        function setupRSVPEventListeners(allowCompanion) {
            // Radio button listeners
            document.getElementById('attendance-yes').addEventListener('change', function() {
                if (this.checked) {
                    document.getElementById('yes-fields').classList.remove('hidden');
                    document.getElementById('no-fields').classList.add('hidden');
                    document.getElementById('submit-rsvp').disabled = false;
                    document.getElementById('guest-name').required = true;
                    document.getElementById('guest-name-no').required = false;
                }
            });
            
            document.getElementById('attendance-no').addEventListener('change', function() {
                if (this.checked) {
                    document.getElementById('no-fields').classList.remove('hidden');
                    document.getElementById('yes-fields').classList.add('hidden');
                    document.getElementById('submit-rsvp').disabled = false;
                    document.getElementById('guest-name-no').required = true;
                    document.getElementById('guest-name').required = false;
                }
            });
            
            // Companion checkbox listener (only if companions are allowed)
            if (allowCompanion) {
                document.getElementById('has-companion').addEventListener('change', function() {
                    const companionField = document.getElementById('companion-field');
                    if (this.checked) {
                        companionField.classList.remove('hidden');
                        document.getElementById('companion-name').required = true;
                    } else {
                        companionField.classList.add('hidden');
                        document.getElementById('companion-name').required = false;
                        document.getElementById('companion-name').value = '';
                    }
                });
            }
            
            // Form submit listener
            document.getElementById('rsvp-form').addEventListener('submit', function(e) {
                e.preventDefault();
                const attendanceYes = document.getElementById('attendance-yes').checked;
                const attendanceNo = document.getElementById('attendance-no').checked;
                
                if (attendanceYes) {
                    submitRSVP(true);
                } else if (attendanceNo) {
                    submitRSVP(false);
                }
            });
        }

        // Render Message Section
        function renderMessageSection() {
            const container = document.getElementById('message-container');
            
            if (userResponse) {
                // User has responded, show message form with pre-filled name
                const displayName = userResponse.companion_name ? 
                    `${userResponse.guest_name} e ${userResponse.companion_name}` : 
                    userResponse.guest_name;
                
                container.innerHTML = `
                    <h3 class="text-2xl sm:text-3xl font-playfair font-semibold mb-4 sm:mb-6 text-gray-800">Deixe uma Mensagem</h3>
                    <form id="message-form" class="space-y-4 sm:space-y-6">
                        <div class="bg-white rounded-xl p-4 border">
                            <p class="text-gray-700 font-medium">Mensagem de: <span class="text-purple-600">${displayName}</span></p>
                        </div>
                        <div class="relative">
                            <textarea id="message-text" placeholder="Sua mensagem especial... üòä" required class="w-full px-4 sm:px-6 py-3 sm:py-4 premium-input rounded-xl focus:outline-none h-24 sm:h-32 text-base sm:text-lg resize-none"></textarea>
                            <button type="button" onclick="toggleEmojiPicker('message-text')" class="emoji-toggle-btn absolute top-3 right-3 bg-gray-100 hover:bg-gray-200 rounded-lg p-2 text-lg transition-colors">
                                üòä
                            </button>
                        </div>
                        <div class="text-center">
                            <button type="submit" class="bg-gradient-to-r from-purple-500 to-pink-500 hover:shadow-xl text-white px-6 sm:px-8 py-3 sm:py-4 rounded-xl font-semibold text-base sm:text-lg transition-all duration-300">
                                üíå Enviar Mensagem
                            </button>
                        </div>
                    </form>
                `;
            } else {
                // User hasn't responded yet, show message that they need to confirm first
                container.innerHTML = `
                    <h3 class="text-2xl sm:text-3xl font-playfair font-semibold mb-4 sm:mb-6 text-gray-800">Deixe uma Mensagem</h3>
                    <div class="bg-white rounded-xl p-6 border border-gray-200 text-center">
                        <p class="text-gray-600 text-lg mb-4">üìù Para deixar uma mensagem, primeiro confirme sua presen√ßa acima.</p>
                        <p class="text-gray-500">Assim saberemos quem est√° enviando a mensagem! üòä</p>
                    </div>
                `;
            }

            // Setup message form if user has responded
            if (userResponse) {
                setTimeout(() => {
                    createEmojiPicker('message-text');
                    document.getElementById('message-form').addEventListener('submit', submitMessage);
                }, 100);
            }
        }

        // Submit RSVP
        async function submitRSVP(attendance) {
            let guestName, companionName = '';
            
            if (attendance) {
                guestName = document.getElementById('guest-name').value;
                const companionField = document.getElementById('companion-name');
                companionName = companionField ? companionField.value : '';
            } else {
                guestName = document.getElementById('guest-name-no').value;
            }

            if (!guestName) {
                alert('Por favor, digite seu nome');
                return;
            }

            // Check if deadline has passed (only if deadline is enabled)
            if (currentEvent.enable_deadline && currentEvent.confirmation_deadline) {
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const deadline = new Date(currentEvent.confirmation_deadline);
                deadline.setHours(23, 59, 59, 999);
                if (today > deadline) {
                    alert('O prazo para confirma√ß√£o j√° passou.');
                    return;
                }
            }

            // Check if event is full (only for confirmations and if limit is enabled)
            if (attendance && currentEvent.enable_max_limit && currentEvent.max_confirmations) {
                try {
                    console.log('Checking capacity for event ID:', currentEvent.id);
                    
                    const { data: confirmedRsvps, error: checkError } = await supabase
                        .from('rsvps')
                        .select('id, attendance')
                        .eq('wedding_id', currentEvent.id)
                        .eq('attendance', true);

                    console.log('Capacity check result:', { confirmedRsvps, checkError });

                    if (checkError) {
                        console.error('Error checking capacity:', checkError);
                        alert(`Erro ao verificar capacidade: ${checkError.message}`);
                        return;
                    }

                    const currentConfirmed = confirmedRsvps ? confirmedRsvps.length : 0;
                    console.log(`Current confirmed: ${currentConfirmed}, Max allowed: ${currentEvent.max_confirmations}`);

                    if (currentConfirmed >= currentEvent.max_confirmations) {
                        alert('Desculpe, o evento j√° atingiu o limite m√°ximo de confirma√ß√µes.');
                        return;
                    }
                } catch (error) {
                    console.error('Error checking capacity:', error);
                    alert(`Erro ao verificar capacidade: ${error.message}`);
                    return;
                }
            }

            try {
                console.log('Submitting RSVP with data:', {
                    wedding_id: currentEvent.id,
                    guest_name: guestName,
                    companion_name: companionName || null,
                    attendance: attendance,
                    message: null
                });

                const { data, error } = await supabase
                    .from('rsvps')
                    .insert({
                        wedding_id: currentEvent.id,
                        guest_name: guestName,
                        companion_name: companionName || null,
                        attendance: attendance,
                        message: null
                    })
                    .select();

                if (error) {
                    console.error('RSVP error details:', error);
                    alert(`Erro ao confirmar presen√ßa: ${error.message || 'Erro desconhecido'}`);
                    return;
                }

                console.log('RSVP submitted successfully:', data);
                
                // Store user response
                userResponse = data[0];
                
                alert(attendance ? 'Presen√ßa confirmada! Obrigado!' : 'Obrigado por nos avisar!');
                
                // Re-render sections to show updated state
                const urlParams = new URLSearchParams(window.location.search);
                const allowCompanion = urlParams.get('companion') !== 'no';
                renderRSVPSection(false, allowCompanion);
                renderMessageSection();

            } catch (error) {
                console.error('Error submitting RSVP:', error);
                alert('Erro de conex√£o. Verifique sua internet e tente novamente.');
            }
        }

        // Load Public Messages for Event Site
        async function loadPublicMessages() {
            try {
                console.log('Loading messages for event ID:', currentEvent.id);
                
                const { data: messages, error } = await supabase
                    .from('rsvps')
                    .select('id, guest_name, message, created_at')
                    .eq('wedding_id', currentEvent.id)
                    .not('message', 'is', null)
                    .neq('message', '')
                    .order('created_at', { ascending: false })
                    .limit(10);

                console.log('Messages loaded:', { messages, error });

                const messagesList = document.getElementById('public-messages-list');
                messagesList.innerHTML = '';

                if (error) {
                    console.error('Error loading messages:', error);
                    messagesList.innerHTML = '<p class="text-center text-gray-500 py-8">Erro ao carregar mensagens</p>';
                    return;
                }

                if (messages && messages.length > 0) {
                    messages.forEach(message => {
                        const messageDiv = document.createElement('div');
                        messageDiv.className = 'bg-white rounded-xl p-4 shadow-sm';
                        messageDiv.innerHTML = `
                            <div class="flex justify-between items-start mb-2">
                                <h4 class="font-semibold text-gray-800">${message.guest_name}</h4>
                                <span class="text-sm text-gray-500">${formatDate(message.created_at)}</span>
                            </div>
                            <p class="text-gray-600">${message.message}</p>
                        `;
                        messagesList.appendChild(messageDiv);
                    });
                } else {
                    messagesList.innerHTML = '<p class="text-center text-gray-500 py-8">Seja o primeiro a deixar uma mensagem! üíï</p>';
                }

            } catch (error) {
                console.error('Error loading public messages:', error);
                const messagesList = document.getElementById('public-messages-list');
                messagesList.innerHTML = '<p class="text-center text-gray-500 py-8">Erro ao carregar mensagens</p>';
            }
        }

        // Submit Message
        async function submitMessage(e) {
            e.preventDefault();
            
            const messageText = document.getElementById('message-text').value;

            if (!messageText) {
                alert('Por favor, escreva uma mensagem');
                return;
            }

            if (!userResponse) {
                alert('Voc√™ precisa confirmar sua presen√ßa primeiro');
                return;
            }

            try {
                console.log('Submitting message with data:', {
                    wedding_id: currentEvent.id,
                    guest_name: userResponse.guest_name,
                    message: messageText,
                    attendance: userResponse.attendance,
                    companion_name: userResponse.companion_name
                });

                const { data, error } = await supabase
                    .from('rsvps')
                    .insert({
                        wedding_id: currentEvent.id,
                        guest_name: userResponse.guest_name,
                        companion_name: userResponse.companion_name,
                        attendance: userResponse.attendance,
                        message: messageText
                    })
                    .select();

                console.log('Message submission result:', { data, error });

                if (error) {
                    console.error('Message error details:', error);
                    alert(`Erro ao enviar mensagem: ${error.message || 'Erro desconhecido'}`);
                    return;
                }

                alert('Mensagem enviada com sucesso!');
                document.getElementById('message-text').value = '';
                
                // Reload public messages to show the new one
                loadPublicMessages();

            } catch (error) {
                console.error('Error submitting message:', error);
                alert('Erro de conex√£o. Verifique sua internet e tente novamente.');
            }
        }

        // Emoji Picker Functions
        const emojis = [
            'üòÄ', 'üòÉ', 'üòÑ', 'üòÅ', 'üòÜ', 'üòÖ', 'üòÇ', 'ü§£',
            'üòä', 'üòá', 'üôÇ', 'üôÉ', 'üòâ', 'üòå', 'üòç', 'ü•∞',
            'üòò', 'üòó', 'üòô', 'üòö', 'üòã', 'üòõ', 'üòù', 'üòú',
            'ü§™', 'ü§®', 'üßê', 'ü§ì', 'üòé', 'ü§©', 'ü•≥', 'üòè',
            'üòí', 'üòû', 'üòî', 'üòü', 'üòï', 'üôÅ', '‚òπÔ∏è', 'üò£',
            'üòñ', 'üò´', 'üò©', 'ü•∫', 'üò¢', 'üò≠', 'üò§', 'üò†',
            'üò°', 'ü§¨', 'ü§Ø', 'üò≥', 'ü•µ', 'ü•∂', 'üò±', 'üò®',
            'üò∞', 'üò•', 'üòì', 'ü§ó', 'ü§î', 'ü§≠', 'ü§´', 'ü§•',
            'üò∂', 'üòê', 'üòë', 'üò¨', 'üôÑ', 'üòØ', 'üò¶', 'üòß',
            'üòÆ', 'üò≤', 'ü•±', 'üò¥', 'ü§§', 'üò™', 'üòµ', 'ü§ê',
            'ü•¥', 'ü§¢', 'ü§Æ', 'ü§ß', 'üò∑', 'ü§í', 'ü§ï', 'ü§ë',
            'ü§†', 'üòà', 'üëø', 'üëπ', 'üë∫', 'ü§°', 'üí©', 'üëª',
            'üíÄ', '‚ò†Ô∏è', 'üëΩ', 'üëæ', 'ü§ñ', 'üéÉ', 'üò∫', 'üò∏',
            'üòπ', 'üòª', 'üòº', 'üòΩ', 'üôÄ', 'üòø', 'üòæ', '‚ù§Ô∏è',
            'üß°', 'üíõ', 'üíö', 'üíô', 'üíú', 'üñ§', 'ü§ç', 'ü§é',
            'üíî', '‚ù£Ô∏è', 'üíï', 'üíû', 'üíì', 'üíó', 'üíñ', 'üíò',
            'üíù', 'üíü', '‚òÆÔ∏è', '‚úùÔ∏è', '‚ò™Ô∏è', 'üïâÔ∏è', '‚ò∏Ô∏è', '‚ú°Ô∏è',
            'üîØ', 'üïé', '‚òØÔ∏è', '‚ò¶Ô∏è', 'üõê', '‚õé', '‚ôà', '‚ôâ',
            '‚ôä', '‚ôã', '‚ôå', '‚ôç', '‚ôé', '‚ôè', '‚ôê', '‚ôë',
            '‚ôí', '‚ôì', 'üÜî', '‚öõÔ∏è', 'üâë', '‚ò¢Ô∏è', '‚ò£Ô∏è', 'üì¥',
            'üì≥', 'üà∂', 'üàö', 'üà∏', 'üà∫', 'üà∑Ô∏è', '‚ú¥Ô∏è', 'üÜö',
            'üíÆ', 'üâê', '„äôÔ∏è', '„äóÔ∏è', 'üà¥', 'üàµ', 'üàπ', 'üà≤',
            'üÖ∞Ô∏è', 'üÖ±Ô∏è', 'üÜé', 'üÜë', 'üÖæÔ∏è', 'üÜò', '‚ùå', '‚≠ï',
            'üõë', '‚õî', 'üìõ', 'üö´', 'üíØ', 'üí¢', '‚ô®Ô∏è', 'üö∑',
            'üöØ', 'üö≥', 'üö±', 'üîû', 'üìµ', 'üö≠', '‚ùó', '‚ùï',
            '‚ùì', '‚ùî', '‚ÄºÔ∏è', '‚ÅâÔ∏è', 'üîÖ', 'üîÜ', '„ÄΩÔ∏è', '‚ö†Ô∏è',
            'üö∏', 'üî±', '‚öúÔ∏è', 'üî∞', '‚ôªÔ∏è', '‚úÖ', 'üàØ', 'üíπ',
            '‚ùáÔ∏è', '‚ú≥Ô∏è', '‚ùé', 'üåê', 'üí†', '‚ìÇÔ∏è', 'üåÄ', 'üí§',
            'üèß', 'üöæ', '‚ôø', 'üÖøÔ∏è', 'üà≥', 'üàÇÔ∏è', 'üõÇ', 'üõÉ',
            'üõÑ', 'üõÖ', 'üöπ', 'üö∫', 'üöº', 'üöª', 'üöÆ', 'üé¶',
            'üì∂', 'üàÅ', 'üî£', '‚ÑπÔ∏è', 'üî§', 'üî°', 'üî†', 'üÜñ',
            'üÜó', 'üÜô', 'üÜí', 'üÜï', 'üÜì', '0Ô∏è‚É£', '1Ô∏è‚É£', '2Ô∏è‚É£',
            '3Ô∏è‚É£', '4Ô∏è‚É£', '5Ô∏è‚É£', '6Ô∏è‚É£', '7Ô∏è‚É£', '8Ô∏è‚É£', '9Ô∏è‚É£', 'üîü'
        ];

        function createEmojiPicker(textareaId) {
            const textarea = document.getElementById(textareaId);
            if (!textarea) return;

            // Create emoji picker container
            const picker = document.createElement('div');
            picker.className = 'emoji-picker';
            picker.id = `emoji-picker-${textareaId}`;

            // Create emoji grid
            const grid = document.createElement('div');
            grid.className = 'emoji-grid';

            emojis.forEach(emoji => {
                const btn = document.createElement('button');
                btn.className = 'emoji-btn';
                btn.textContent = emoji;
                btn.type = 'button';
                btn.onclick = () => {
                    const cursorPos = textarea.selectionStart;
                    const textBefore = textarea.value.substring(0, cursorPos);
                    const textAfter = textarea.value.substring(textarea.selectionEnd);
                    textarea.value = textBefore + emoji + textAfter;
                    textarea.focus();
                    textarea.setSelectionRange(cursorPos + emoji.length, cursorPos + emoji.length);
                    picker.classList.remove('show');
                };
                grid.appendChild(btn);
            });

            picker.appendChild(grid);
            textarea.parentNode.style.position = 'relative';
            textarea.parentNode.appendChild(picker);

            return picker;
        }

        function toggleEmojiPicker(textareaId) {
            const picker = document.getElementById(`emoji-picker-${textareaId}`);
            if (picker) {
                picker.classList.toggle('show');
            }
        }

        // Close emoji picker when clicking outside
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.emoji-picker') && !e.target.closest('.emoji-toggle-btn')) {
                document.querySelectorAll('.emoji-picker').forEach(picker => {
                    picker.classList.remove('show');
                });
            }
        });

        // Check User Response
        async function checkUserResponse(guestName) {
            try {
                const { data: response } = await supabase
                    .from('rsvps')
                    .select('*')
                    .eq('wedding_id', currentEvent.id)
                    .eq('guest_name', guestName)
                    .single();

                return response;
            } catch (error) {
                return null;
            }
        }

        // Edit Response Function
        function editResponse() {
            userResponse = null;
            renderEventSite();
        }

        // Initialize
        if (!clienteParam) {
            showSection('home');
        }
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'972a35bbf5f477da',t:'MTc1NTc4MDE0MS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
